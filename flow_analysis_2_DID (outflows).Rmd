This file will complete the first regression needed for the flow data: a limited difference-in-difference analysis of the Kyrgyz migrant flows (region-by-year 2021-23) over time.

Of interest:
- significance and magnitude of the coefficients on time fixed effect dummies --> quantify impact of war onset and continuation
- selection, significance, and magnitude of covariates --> understand pull factors for kyrgyz migrants to russia

```{r}
library(dplyr)
library(readr)
```

```{r}
region_year_data <- read_csv("/Users/michelle/Documents/thesis/region-year-data.csv") %>%
  dplyr::select(-contains("count_"), -contains("pct_"), -contains("ratio_")) %>%
#remove yandex trends
  filter(!is.na(Outflow))  # Remove rows where Outflow is NA, if any
```

Drop unnecessary variables, /100 for percentage variables that haven't gotten that treatment already.
```{r}
# Drop columns that need log transformation therefore we cannot include with levels
region_year_data <- region_year_data[, !(names(region_year_data) %in% c("minwagevalue", "total_pop", "city_pop", "rural_pop", "avg_nominal_gross_wages", "lag_total_pop", "lag_city_pop", "lag_rural_pop", "lag_avg_nominal_gross_wages"))]

# Divide selected columns by 100
region_year_data[c("change_in_output", "change_in_real_avg_wages", "changeinindustrialproduction_all", 
                   "changeinindustrialproduction_mineral_extraction", "changeinindustrialproduction_manufacturing", 
                   "changeinindustrialproduction_electricity_utilities", "changeinindustrialproduction_water_utilities", 
                   "lag_changeinindustrialproduction_mineral_extraction", "lag_changeinindustrialproduction_manufacturing", 
                   "lag_changeinindustrialproduction_electricity_utilities", "lag_changeinindustrialproduction_water_utilities")] <- 
  region_year_data[c("change_in_output", "change_in_real_avg_wages", "changeinindustrialproduction_all", 
                     "changeinindustrialproduction_mineral_extraction", "changeinindustrialproduction_manufacturing", 
                     "changeinindustrialproduction_electricity_utilities", "changeinindustrialproduction_water_utilities", 
                     "lag_changeinindustrialproduction_mineral_extraction", "lag_changeinindustrialproduction_manufacturing", 
                     "lag_changeinindustrialproduction_electricity_utilities", "lag_changeinindustrialproduction_water_utilities")] / 100

# Remove columns with missing first observations
region_year_data <- region_year_data[, !(names(region_year_data) %in% c("lag_minwagevalue", "lag_log_minwagevalue"))]

# Keep the original columns as-is (this part is already implicitly handled by not applying any transformation to the specified columns)
# You don't need to do anything for columns like "Region", "Year", "Outflow", "poverty_rate", etc.
```

Prep by removing NAs
```{r}
library(dplyr)

# Identify rows with NA values and return the Year, Region, and the variable(s) with NA
na_data <- region_year_data %>%
  tidyr::gather(key = "variable", value = "value", -Year, -Region) %>%
  filter(is.na(value)) %>%
  dplyr::select(Year, Region, variable)

# View the result
head(na_data) #No NAs left!
```

Prep by removing time trends (sample too small) and adding a post-war dummy. 
```{r}
region_year_data <- region_year_data %>%
  # Add the postwar dummy variable
  mutate(war = if_else(Year >= 2022, 1, 0)) %>%
  mutate(postwar = if_else(Year >= 2022, Year - 2021, 0)) 
```

Output folder
```{r}
output_directory <- "/Users/michelle/Documents/thesis/MODEL OUTPUT/OUTFLOWS" 
```


#A: Plain DID 

```{r}
region_year_data_copy <- region_year_data %>%
  dplyr::select(-mediazona) #needs to be logged only
region_year_data <- region_year_data %>%
  dplyr::select(-Inflow, -Netflow) %>%
  dplyr::select(-contains("mediazona"))
```

## A_X: No fixed effects (not really functional due to lack of predictors)

```{r}
# Load necessary libraries
library(lmtest)  # For coeftest function
library(sandwich) # For robust standard errors

# Create the formula for the model (Outflow as the dependent variable) without an intercept
formula <- as.formula(paste("log1p(Outflow) ~ ",   # Remove the intercept with "0 +"
                            paste(c("war", "postwar"), collapse = " + ")))  

# Fit the full model using all covariates and fixed effects
full_model <- lm(formula, data = region_year_data)

# Obtain robust standard errors
robust_se <- vcovHC(full_model, type = "HC3")  # HC3 for robust SE

# Get the summary with robust standard errors
robust_summary <- coeftest(full_model, vcov = robust_se)  # Robust errors

# Compare standard vs. robust results
summary(full_model) # Standard errors
print(robust_summary) # Robust errors
```

```{r}
# 1. Breusch-Pagan test for heteroskedasticity
library(lmtest)
bptest(full_model, studentize = TRUE)
bptest(full_model, studentize = FALSE)

# 2. Residual plot
# Plot residuals vs fitted values to visually inspect for heteroskedasticity
plot(full_model$fitted.values, full_model$residuals, 
     main = "Residual Plot (Model 1A)", 
     xlab = "Fitted Values", 
     ylab = "Residuals", 
     pch = 16, col = "blue")
abline(h = 0, col = "red", lwd = 2)

# Optional: To further check for heteroskedasticity, you can use a scale-location plot
plot(full_model, which = 3)
```

```{r save}
model_name <- "A_X"  # Replace this with your model name or identifier

# Save the standard summary output of the stepwise model
summary_file <- file.path(output_directory, paste0(model_name, "_summary_", ".txt"))
capture.output(summary(full_model), file = summary_file)

# Save the robust summary output with robust standard errors
robust_summary_file <- file.path(output_directory, paste0(model_name, "_robust_summary_", ".txt"))
capture.output(print(robust_summary), file = robust_summary_file)

# Print out the file locations for confirmation
cat("Files saved to:\n")
cat("Model Summary: ", summary_file, "\n")
cat("Robust Summary: ", robust_summary_file, "\n")
```


## A_FE: With fixed effects (not really functional due to overfit)

```{r}
# Load necessary libraries
library(clubSandwich)
library(lmtest)  # For coeftest function

# Create the formula for the model (Outflow as the dependent variable) without an intercept
formula <- as.formula(paste("log1p(Outflow) ~ 0 +",   # Remove the intercept with "0 +"
                            paste(c("war", "postwar", "factor(Region)"), collapse = " + ")))  

# Fit the full model using all covariates and fixed effects
full_model <- lm(formula, data = region_year_data)

# Obtain robust standard errors
robust_se <- vcovHC(full_model, type = "HC3")  # HC3 for robust SE

# Get the summary with robust standard errors
robust_summary <- coeftest(full_model, vcov = robust_se)  # Robust errors

# Compare standard vs. robust results
print(summary(full_model))  # Standard errors
print(robust_summary) # Robust errors

# Extract and print Adjusted R-squared and F-statistic from the summary
adj_r_squared <- summary(full_model)$adj.r.squared
f_stat <- summary(full_model)$fstatistic

cat("Adjusted R-squared: ", adj_r_squared, "\n")
cat("F-statistic: ", f_stat[1], " on ", f_stat[2], " and ", f_stat[3], " DF \n")
```

```{r}
# Create a table with actual values and fitted values
fitted_vs_actual <- data.frame(
  Region = region_year_data$Region,  # Region identifier
  Year = region_year_data$Year,  # If you have a Year variable
  Actual_Outflow = log(region_year_data$Outflow),  # Actual Outflow values
  Fitted_Outflow = log(expm1(fitted(full_model)))  # Convert log1p back to original scale
)

# Print the table
print(fitted_vs_actual)
```

```{r}
# 1. Breusch-Pagan test for heteroskedasticity
library(lmtest)
bptest(full_model, studentize = TRUE)
bptest(full_model, studentize = FALSE)

# 2. Residual plot
# Plot residuals vs fitted values to visually inspect for heteroskedasticity
plot(full_model$fitted.values, full_model$residuals, 
     main = "Residual Plot (Model 1A)", 
     xlab = "Fitted Values", 
     ylab = "Residuals", 
     pch = 16, col = "blue")
abline(h = 0, col = "red", lwd = 2)

# Optional: To further check for heteroskedasticity, you can use a scale-location plot
plot(full_model, which = 3)
```

```{r save}
model_name <- "A_FE"

# Save the standard summary output of the stepwise model
summary_file <- file.path(output_directory, paste0(model_name, "_summary_", ".txt"))
capture.output(summary(full_model), file = summary_file)

# Save the robust summary output with robust standard errors
robust_summary_file <- file.path(output_directory, paste0(model_name, "_robust_summary_", ".txt"))
capture.output(print(robust_summary), file = robust_summary_file)

# Print out the file locations for confirmation
cat("Files saved to:\n")
cat("Model Summary: ", summary_file, "\n")
cat("Robust Summary: ", robust_summary_file, "\n")
```


#B: DID with covariates

##B_X_BIC: NO fixed effects + BIC

```{r}
# Load necessary libraries
library(sandwich)  # For robust standard errors
library(lmtest)    # For coeftest function

# Create the formula for the model (Outflow as the dependent variable)
formula <- as.formula(paste("log1p(Outflow) ~ ",  
                            paste(names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))], collapse = " + ")))

full_model <- lm(formula, data = region_year_data)

# Note: We specify k = log(n) to use BIC instead of AIC
stepwise_model <- step(full_model, direction = "both", k = log(nrow(region_year_data)), trace = 1)

# Obtain robust standard errors
robust_se <- vcovHC(stepwise_model, type = "HC3")  # HC3 for robust SE

# Get the summary with robust standard errors
robust_summary <- coeftest(stepwise_model, vcov = robust_se)  # Robust errors

# Compare standard vs. robust results
print(summary(stepwise_model)) # Standard errors
print(robust_summary) # Robust errors

# Extract and print Adjusted R-squared and F-statistic from the summary
adj_r_squared <- summary(stepwise_model)$adj.r.squared
f_stat <- summary(stepwise_model)$fstatistic

cat("Adjusted R-squared: ", adj_r_squared, "\n")
cat("F-statistic: ", f_stat[1], " on ", f_stat[2], " and ", f_stat[3], " DF \n")
```

```{r}
# 1. Breusch-Pagan test for heteroskedasticity
library(lmtest)
bptest(stepwise_model, studentize = TRUE)
bptest(stepwise_model, studentize = FALSE)

# 2. Residual plot
# Plot residuals vs fitted values to visually inspect for heteroskedasticity
plot(stepwise_model$fitted.values, stepwise_model$residuals, 
     main = "Residual Plot (Model 1B)", 
     xlab = "Fitted Values", 
     ylab = "Residuals", 
     pch = 16, col = "blue")
abline(h = 0, col = "red", lwd = 2)

# Optional: To further check for heteroskedasticity, you can use a scale-location plot
plot(stepwise_model, which = 3)
```

```{r save}
model_name <- "B_X_BIC"

# Save the standard summary output of the stepwise model
summary_file <- file.path(output_directory, paste0(model_name, "_summary_", ".txt"))
capture.output(summary(stepwise_model), file = summary_file)

# Save the robust summary output with robust standard errors
robust_summary_file <- file.path(output_directory, paste0(model_name, "_robust_summary_", ".txt"))
capture.output(print(robust_summary), file = robust_summary_file)

# Identify all potential covariates (excluding 'Region', 'Year', and 'Outflow')
all_covariates <- names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))]
selected_covariates <- names(coef(stepwise_model))[-1]  # Exclude intercept
non_selected_covariates <- setdiff(all_covariates, selected_covariates)
non_selected_file <- file.path(output_directory, paste0(model_name, "_non_selected_covariates.txt"))
capture.output(cat("Non-selected covariates:\n", paste(non_selected_covariates, collapse = ", "), "\n"),
               file = non_selected_file)

# Print out the file locations for confirmation
cat("Files saved to:\n")
cat("Model Summary: ", summary_file, "\n")
cat("Robust Summary: ", robust_summary_file, "\n")
cat("Non-selected covariates saved to:", non_selected_file, "\n")
```


##B_FE_BIC: With fixed effects + BIC

```{r}
# Load necessary libraries
library(sandwich)  # For robust standard errors
library(lmtest)    # For coeftest function

# Prepare the data (remove unwanted columns)
region_year_data <- region_year_data %>% 
  dplyr::select(-contains("mediazona"))

# Create the formula for the model (Outflow as the dependent variable)
formula <- as.formula(paste("log1p(Outflow) ~ ",  
                            paste(names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))], collapse = " + "),  
                            "+ factor(Region)"))

full_model <- lm(formula, data = region_year_data)

# Note: We specify k = log(n) to use BIC instead of AIC
stepwise_model <- step(full_model, direction = "both", k = log(nrow(region_year_data)), trace = 1)

# Obtain robust standard errors
robust_se <- vcovHC(stepwise_model, type = "HC3")  # HC3 for robust SE

# Get the summary with robust standard errors
robust_summary <- coeftest(stepwise_model, vcov = robust_se)  # Robust errors

# Compare standard vs. robust results
print(summary(stepwise_model))  # Standard errors
print(robust_summary) # Robust errors

# Extract and print Adjusted R-squared and F-statistic from the summary
adj_r_squared <- summary(stepwise_model)$adj.r.squared
f_stat <- summary(stepwise_model)$fstatistic

cat("Adjusted R-squared: ", adj_r_squared, "\n")
cat("F-statistic: ", f_stat[1], " on ", f_stat[2], " and ", f_stat[3], " DF \n")
```

```{r}
# 1. Breusch-Pagan test for heteroskedasticity
library(lmtest)
bptest(stepwise_model, studentize = TRUE)
bptest(stepwise_model, studentize = FALSE)

# 2. Residual plot
# Plot residuals vs fitted values to visually inspect for heteroskedasticity
plot(stepwise_model$fitted.values, stepwise_model$residuals, 
     main = "Residual Plot (Model 1B)", 
     xlab = "Fitted Values", 
     ylab = "Residuals", 
     pch = 16, col = "blue")
abline(h = 0, col = "red", lwd = 2)

# Optional: To further check for heteroskedasticity, you can use a scale-location plot
plot(stepwise_model, which = 3)
```

```{r save}
model_name <- "B_FE_BIC"

# Save the standard summary output of the stepwise model
summary_file <- file.path(output_directory, paste0(model_name, "_summary_", ".txt"))
capture.output(summary(stepwise_model), file = summary_file)

# Save the robust summary output with robust standard errors
robust_summary_file <- file.path(output_directory, paste0(model_name, "_robust_summary_", ".txt"))
capture.output(print(robust_summary), file = robust_summary_file)

# Identify all potential covariates (excluding 'Region', 'Year', and 'Outflow')
all_covariates <- names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))]
selected_covariates <- names(coef(stepwise_model))[-1]  # Exclude intercept
non_selected_covariates <- setdiff(all_covariates, selected_covariates)
non_selected_file <- file.path(output_directory, paste0(model_name, "_non_selected_covariates.txt"))
capture.output(cat("Non-selected covariates:\n", paste(non_selected_covariates, collapse = ", "), "\n"),
               file = non_selected_file)

# Print out the file locations for confirmation
cat("Files saved to:\n")
cat("Model Summary: ", summary_file, "\n")
cat("Robust Summary: ", robust_summary_file, "\n")
cat("Non-selected covariates saved to:", non_selected_file, "\n")
```


##B_X_AIC: NO fixed effects + AIC

```{r}
# Load necessary libraries
library(sandwich)  # For robust standard errors
library(lmtest)    # For coeftest function

# Create the formula for the model (Outflow as the dependent variable)
formula <- as.formula(paste("log1p(Outflow) ~ ",  
                            paste(names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))], collapse = " + ")))

full_model <- lm(formula, data = region_year_data)

# Note: We specify k = log(n) to use BIC instead of AIC
stepwise_model <- step(full_model, direction = "both", trace = 1)

# Obtain robust standard errors
robust_se <- vcovHC(stepwise_model, type = "HC3")  # HC3 for robust SE

# Get the summary with robust standard errors
robust_summary <- coeftest(stepwise_model, vcov = robust_se)  # Robust errors

# Compare standard vs. robust results
print(summary(stepwise_model)) # Standard errors
print(robust_summary) # Robust errors

# Extract and print Adjusted R-squared and F-statistic from the summary
adj_r_squared <- summary(stepwise_model)$adj.r.squared
f_stat <- summary(stepwise_model)$fstatistic

cat("Adjusted R-squared: ", adj_r_squared, "\n")
cat("F-statistic: ", f_stat[1], " on ", f_stat[2], " and ", f_stat[3], " DF \n")
```

```{r}
# 1. Breusch-Pagan test for heteroskedasticity
library(lmtest)
bptest(stepwise_model, studentize = TRUE)
bptest(stepwise_model, studentize = FALSE)

# 2. Residual plot
# Plot residuals vs fitted values to visually inspect for heteroskedasticity
plot(stepwise_model$fitted.values, stepwise_model$residuals, 
     main = "Residual Plot (Model 1B)", 
     xlab = "Fitted Values", 
     ylab = "Residuals", 
     pch = 16, col = "blue")
abline(h = 0, col = "red", lwd = 2)

# Optional: To further check for heteroskedasticity, you can use a scale-location plot
plot(stepwise_model, which = 3)
```

```{r save}
model_name <- "B_X_AIC"

# Save the standard summary output of the stepwise model
summary_file <- file.path(output_directory, paste0(model_name, "_summary_", ".txt"))
capture.output(summary(stepwise_model), file = summary_file)

# Save the robust summary output with robust standard errors
robust_summary_file <- file.path(output_directory, paste0(model_name, "_robust_summary_", ".txt"))
capture.output(print(robust_summary), file = robust_summary_file)

# Identify all potential covariates (excluding 'Region', 'Year', and 'Outflow')
all_covariates <- names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))]
selected_covariates <- names(coef(stepwise_model))[-1]  # Exclude intercept
non_selected_covariates <- setdiff(all_covariates, selected_covariates)
non_selected_file <- file.path(output_directory, paste0(model_name, "_non_selected_covariates.txt"))
capture.output(cat("Non-selected covariates:\n", paste(non_selected_covariates, collapse = ", "), "\n"),
               file = non_selected_file)

# Print out the file locations for confirmation
cat("Files saved to:\n")
cat("Model Summary: ", summary_file, "\n")
cat("Robust Summary: ", robust_summary_file, "\n")
cat("Non-selected covariates saved to:", non_selected_file, "\n")
```


##B_FE_AIC: With fixed effects + AIC

```{r}
# Load necessary libraries
library(sandwich)  # For robust standard errors
library(lmtest)    # For coeftest function

# Prepare the data (remove unwanted columns)
region_year_data <- region_year_data %>% 
  dplyr::select(-contains("mediazona"))

# Create the formula for the model (Outflow as the dependent variable)
formula <- as.formula(paste("log1p(Outflow) ~ ",  
                            paste(names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))], collapse = " + "),  
                            "+ factor(Region)"))

full_model <- lm(formula, data = region_year_data)

# Note: We specify k = log(n) to use BIC instead of AIC
stepwise_model <- step(full_model, direction = "both", trace = 1)

# Obtain robust standard errors
robust_se <- vcovHC(stepwise_model, type = "HC3")  # HC3 for robust SE

# Get the summary with robust standard errors
robust_summary <- coeftest(stepwise_model, vcov = robust_se)  # Robust errors

# Compare standard vs. robust results
print(summary(stepwise_model))  # Standard errors
print(robust_summary) # Robust errors

# Extract and print Adjusted R-squared and F-statistic from the summary
adj_r_squared <- summary(stepwise_model)$adj.r.squared
f_stat <- summary(stepwise_model)$fstatistic

cat("Adjusted R-squared: ", adj_r_squared, "\n")
cat("F-statistic: ", f_stat[1], " on ", f_stat[2], " and ", f_stat[3], " DF \n")
```

```{r}
# 1. Breusch-Pagan test for heteroskedasticity
library(lmtest)
bptest(stepwise_model, studentize = TRUE)
bptest(stepwise_model, studentize = FALSE)

# 2. Residual plot
# Plot residuals vs fitted values to visually inspect for heteroskedasticity
plot(stepwise_model$fitted.values, stepwise_model$residuals, 
     main = "Residual Plot (Model 1B)", 
     xlab = "Fitted Values", 
     ylab = "Residuals", 
     pch = 16, col = "blue")
abline(h = 0, col = "red", lwd = 2)

# Optional: To further check for heteroskedasticity, you can use a scale-location plot
plot(stepwise_model, which = 3)
```

```{r save}
model_name <- "B_FE_AIC"

# Save the standard summary output of the stepwise model
summary_file <- file.path(output_directory, paste0(model_name, "_summary_", ".txt"))
capture.output(summary(stepwise_model), file = summary_file)

# Save the robust summary output with robust standard errors
robust_summary_file <- file.path(output_directory, paste0(model_name, "_robust_summary_", ".txt"))
capture.output(print(robust_summary), file = robust_summary_file)

# Identify all potential covariates (excluding 'Region', 'Year', and 'Outflow')
all_covariates <- names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))]
selected_covariates <- names(coef(stepwise_model))[-1]  # Exclude intercept
non_selected_covariates <- setdiff(all_covariates, selected_covariates)
non_selected_file <- file.path(output_directory, paste0(model_name, "_non_selected_covariates.txt"))
capture.output(cat("Non-selected covariates:\n", paste(non_selected_covariates, collapse = ", "), "\n"),
               file = non_selected_file)

# Print out the file locations for confirmation
cat("Files saved to:\n")
cat("Model Summary: ", summary_file, "\n")
cat("Robust Summary: ", robust_summary_file, "\n")
cat("Non-selected covariates saved to:", non_selected_file, "\n")
```



#C: DID adding Mediazona casualties (labor substitution analysis)
We simply add mediazona data back into the mix and see if it is selected and what its coefficients look like. 

```{r prep}
region_year_data <- region_year_data_copy %>%
  dplyr::select(-Inflow, -Netflow)
```

##C_X_BIC: NO fixed effects + BIC

```{r}
# Load necessary libraries
library(sandwich)  # For robust standard errors
library(lmtest)    # For coeftest function

# Create the formula for the model (Outflow as the dependent variable)
formula <- as.formula(paste("log1p(Outflow) ~ ",  
                            paste(names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))], collapse = " + ")))

full_model <- lm(formula, data = region_year_data)

# Note: We specify k = log(n) to use BIC instead of AIC
stepwise_model <- step(full_model, direction = "both", k = log(nrow(region_year_data)), trace = 1)

# Obtain robust standard errors
robust_se <- vcovHC(stepwise_model, type = "HC3")  # HC3 for robust SE

# Get the summary with robust standard errors
robust_summary <- coeftest(stepwise_model, vcov = robust_se)  # Robust errors

# Compare standard vs. robust results
print(summary(stepwise_model)) # Standard errors
print(robust_summary) # Robust errors

# Extract and print Adjusted R-squared and F-statistic from the summary
adj_r_squared <- summary(stepwise_model)$adj.r.squared
f_stat <- summary(stepwise_model)$fstatistic

cat("Adjusted R-squared: ", adj_r_squared, "\n")
cat("F-statistic: ", f_stat[1], " on ", f_stat[2], " and ", f_stat[3], " DF \n")
```

```{r}
# 1. Breusch-Pagan test for heteroskedasticity
library(lmtest)
bptest(stepwise_model, studentize = TRUE)
bptest(stepwise_model, studentize = FALSE)

# 2. Residual plot
# Plot residuals vs fitted values to visually inspect for heteroskedasticity
plot(stepwise_model$fitted.values, stepwise_model$residuals, 
     main = "Residual Plot (Model 1B)", 
     xlab = "Fitted Values", 
     ylab = "Residuals", 
     pch = 16, col = "blue")
abline(h = 0, col = "red", lwd = 2)

# Optional: To further check for heteroskedasticity, you can use a scale-location plot
plot(stepwise_model, which = 3)
```

```{r save}
model_name <- "C_X_BIC"

# Save the standard summary output of the stepwise model
summary_file <- file.path(output_directory, paste0(model_name, "_summary_", ".txt"))
capture.output(summary(stepwise_model), file = summary_file)

# Save the robust summary output with robust standard errors
robust_summary_file <- file.path(output_directory, paste0(model_name, "_robust_summary_", ".txt"))
capture.output(print(robust_summary), file = robust_summary_file)

# Identify all potential covariates (excluding 'Region', 'Year', and 'Outflow')
all_covariates <- names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))]
selected_covariates <- names(coef(stepwise_model))[-1]  # Exclude intercept
non_selected_covariates <- setdiff(all_covariates, selected_covariates)
non_selected_file <- file.path(output_directory, paste0(model_name, "_non_selected_covariates.txt"))
capture.output(cat("Non-selected covariates:\n", paste(non_selected_covariates, collapse = ", "), "\n"),
               file = non_selected_file)

# Print out the file locations for confirmation
cat("Files saved to:\n")
cat("Model Summary: ", summary_file, "\n")
cat("Robust Summary: ", robust_summary_file, "\n")
cat("Non-selected covariates saved to:", non_selected_file, "\n")
```

##C_FE_BIC: With fixed effects + BIC

```{r}
# Load necessary libraries
library(sandwich)  # For robust standard errors
library(lmtest)    # For coeftest function

# Create the formula for the model (Outflow as the dependent variable)
formula <- as.formula(paste("log1p(Outflow) ~ ",  
                            paste(names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))], collapse = " + "),  
                            "+ factor(Region)"))

full_model <- lm(formula, data = region_year_data)

# Note: We specify k = log(n) to use BIC instead of AIC
stepwise_model <- step(full_model, direction = "both", k = log(nrow(region_year_data)), trace = 1)

# Obtain robust standard errors
robust_se <- vcovHC(stepwise_model, type = "HC3")  # HC3 for robust SE

# Get the summary with robust standard errors
robust_summary <- coeftest(stepwise_model, vcov = robust_se)  # Robust errors

# Compare standard vs. robust results
print(summary(stepwise_model))  # Standard errors
print(robust_summary) # Robust errors

# Extract and print Adjusted R-squared and F-statistic from the summary
adj_r_squared <- summary(stepwise_model)$adj.r.squared
f_stat <- summary(stepwise_model)$fstatistic

cat("Adjusted R-squared: ", adj_r_squared, "\n")
cat("F-statistic: ", f_stat[1], " on ", f_stat[2], " and ", f_stat[3], " DF \n")
```

```{r}
# 1. Breusch-Pagan test for heteroskedasticity
library(lmtest)
bptest(stepwise_model, studentize = TRUE)
bptest(stepwise_model, studentize = FALSE)

# 2. Residual plot
# Plot residuals vs fitted values to visually inspect for heteroskedasticity
plot(stepwise_model$fitted.values, stepwise_model$residuals, 
     main = "Residual Plot (Model 1B)", 
     xlab = "Fitted Values", 
     ylab = "Residuals", 
     pch = 16, col = "blue")
abline(h = 0, col = "red", lwd = 2)

# Optional: To further check for heteroskedasticity, you can use a scale-location plot
plot(stepwise_model, which = 3)
```

```{r save}
model_name <- "C_FE_BIC"

# Save the standard summary output of the stepwise model
summary_file <- file.path(output_directory, paste0(model_name, "_summary_", ".txt"))
capture.output(summary(stepwise_model), file = summary_file)

# Save the robust summary output with robust standard errors
robust_summary_file <- file.path(output_directory, paste0(model_name, "_robust_summary_", ".txt"))
capture.output(print(robust_summary), file = robust_summary_file)

# Identify all potential covariates (excluding 'Region', 'Year', and 'Outflow')
all_covariates <- names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))]
selected_covariates <- names(coef(stepwise_model))[-1]  # Exclude intercept
non_selected_covariates <- setdiff(all_covariates, selected_covariates)
non_selected_file <- file.path(output_directory, paste0(model_name, "_non_selected_covariates.txt"))
capture.output(cat("Non-selected covariates:\n", paste(non_selected_covariates, collapse = ", "), "\n"),
               file = non_selected_file)

# Print out the file locations for confirmation
cat("Files saved to:\n")
cat("Model Summary: ", summary_file, "\n")
cat("Robust Summary: ", robust_summary_file, "\n")
cat("Non-selected covariates saved to:", non_selected_file, "\n")
```

##C_X_AIC: NO fixed effects + AIC

```{r}
# Load necessary libraries
library(sandwich)  # For robust standard errors
library(lmtest)    # For coeftest function

# Create the formula for the model (Outflow as the dependent variable)
formula <- as.formula(paste("log1p(Outflow) ~ ",  
                            paste(names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))], collapse = " + ")))

full_model <- lm(formula, data = region_year_data)

# Note: We specify k = log(n) to use BIC instead of AIC
stepwise_model <- step(full_model, direction = "both", trace = 1)

# Obtain robust standard errors
robust_se <- vcovHC(stepwise_model, type = "HC3")  # HC3 for robust SE

# Get the summary with robust standard errors
robust_summary <- coeftest(stepwise_model, vcov = robust_se)  # Robust errors

# Compare standard vs. robust results
print(summary(stepwise_model)) # Standard errors
print(robust_summary) # Robust errors

# Extract and print Adjusted R-squared and F-statistic from the summary
adj_r_squared <- summary(stepwise_model)$adj.r.squared
f_stat <- summary(stepwise_model)$fstatistic

cat("Adjusted R-squared: ", adj_r_squared, "\n")
cat("F-statistic: ", f_stat[1], " on ", f_stat[2], " and ", f_stat[3], " DF \n")
```

```{r}
# 1. Breusch-Pagan test for heteroskedasticity
library(lmtest)
bptest(stepwise_model, studentize = TRUE)
bptest(stepwise_model, studentize = FALSE)

# 2. Residual plot
# Plot residuals vs fitted values to visually inspect for heteroskedasticity
plot(stepwise_model$fitted.values, stepwise_model$residuals, 
     main = "Residual Plot (Model 1B)", 
     xlab = "Fitted Values", 
     ylab = "Residuals", 
     pch = 16, col = "blue")
abline(h = 0, col = "red", lwd = 2)

# Optional: To further check for heteroskedasticity, you can use a scale-location plot
plot(stepwise_model, which = 3)
```

```{r save}
model_name <- "C_X_AIC"

# Save the standard summary output of the stepwise model
summary_file <- file.path(output_directory, paste0(model_name, "_summary_", ".txt"))
capture.output(summary(stepwise_model), file = summary_file)

# Save the robust summary output with robust standard errors
robust_summary_file <- file.path(output_directory, paste0(model_name, "_robust_summary_", ".txt"))
capture.output(print(robust_summary), file = robust_summary_file)

# Identify all potential covariates (excluding 'Region', 'Year', and 'Outflow')
all_covariates <- names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))]
selected_covariates <- names(coef(stepwise_model))[-1]  # Exclude intercept
non_selected_covariates <- setdiff(all_covariates, selected_covariates)
non_selected_file <- file.path(output_directory, paste0(model_name, "_non_selected_covariates.txt"))
capture.output(cat("Non-selected covariates:\n", paste(non_selected_covariates, collapse = ", "), "\n"),
               file = non_selected_file)

# Print out the file locations for confirmation
cat("Files saved to:\n")
cat("Model Summary: ", summary_file, "\n")
cat("Robust Summary: ", robust_summary_file, "\n")
cat("Non-selected covariates saved to:", non_selected_file, "\n")
```

##C_FE_AIC: With fixed effects + AIC

```{r}
# Load necessary libraries
library(sandwich)  # For robust standard errors
library(lmtest)    # For coeftest function

# Create the formula for the model (Outflow as the dependent variable)
formula <- as.formula(paste("log1p(Outflow) ~ ",  
                            paste(names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))], collapse = " + "),  
                            "+ factor(Region)"))

full_model <- lm(formula, data = region_year_data)

# Note: We specify k = log(n) to use BIC instead of AIC
stepwise_model <- step(full_model, direction = "both", trace = 1)

# Obtain robust standard errors
robust_se <- vcovHC(stepwise_model, type = "HC3")  # HC3 for robust SE

# Get the summary with robust standard errors
robust_summary <- coeftest(stepwise_model, vcov = robust_se)  # Robust errors

# Compare standard vs. robust results
print(summary(stepwise_model))  # Standard errors
print(robust_summary) # Robust errors

# Extract and print Adjusted R-squared and F-statistic from the summary
adj_r_squared <- summary(stepwise_model)$adj.r.squared
f_stat <- summary(stepwise_model)$fstatistic

cat("Adjusted R-squared: ", adj_r_squared, "\n")
cat("F-statistic: ", f_stat[1], " on ", f_stat[2], " and ", f_stat[3], " DF \n")
```

```{r}
# 1. Breusch-Pagan test for heteroskedasticity
library(lmtest)
bptest(stepwise_model, studentize = TRUE)
bptest(stepwise_model, studentize = FALSE)

# 2. Residual plot
# Plot residuals vs fitted values to visually inspect for heteroskedasticity
plot(stepwise_model$fitted.values, stepwise_model$residuals, 
     main = "Residual Plot (Model 1B)", 
     xlab = "Fitted Values", 
     ylab = "Residuals", 
     pch = 16, col = "blue")
abline(h = 0, col = "red", lwd = 2)

# Optional: To further check for heteroskedasticity, you can use a scale-location plot
plot(stepwise_model, which = 3)
```

```{r save}
model_name <- "C_FE_AIC"

# Save the standard summary output of the stepwise model
summary_file <- file.path(output_directory, paste0(model_name, "_summary_", ".txt"))
capture.output(summary(stepwise_model), file = summary_file)

# Save the robust summary output with robust standard errors
robust_summary_file <- file.path(output_directory, paste0(model_name, "_robust_summary_", ".txt"))
capture.output(print(robust_summary), file = robust_summary_file)

# Identify all potential covariates (excluding 'Region', 'Year', and 'Outflow')
all_covariates <- names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))]
selected_covariates <- names(coef(stepwise_model))[-1]  # Exclude intercept
non_selected_covariates <- setdiff(all_covariates, selected_covariates)
non_selected_file <- file.path(output_directory, paste0(model_name, "_non_selected_covariates.txt"))
capture.output(cat("Non-selected covariates:\n", paste(non_selected_covariates, collapse = ", "), "\n"),
               file = non_selected_file)

# Print out the file locations for confirmation
cat("Files saved to:\n")
cat("Model Summary: ", summary_file, "\n")
cat("Robust Summary: ", robust_summary_file, "\n")
cat("Non-selected covariates saved to:", non_selected_file, "\n")
```





#D: extended time series! 

```{r}
extended_time_series_flows <- read_csv("/Users/michelle/Documents/thesis/extended_time_series_OUTflows_noeconomiccovariates.csv") %>%
  mutate(across(.cols = -c(Year, Region), .fns = ~ if_else(. < 0, 0, .)))

region_year_data <- read_csv("/Users/michelle/Documents/thesis/region-year-data.csv") %>%
  filter(Year > 2018) %>%
  dplyr::select(-contains("count_"), -contains("pct_"), -contains("ratio_"))

# Retain actual Outflow data where available, otherwise use nowcasted values
region_year_data <- region_year_data %>%
  left_join(extended_time_series_flows %>% dplyr::select(Year, Region, `Fitted Values`), 
            by = c("Year", "Region")) %>%
  mutate(Outflow = coalesce(Outflow, `Fitted Values`)) %>%
  dplyr::select(-`Fitted Values`, -Inflow, -Netflow)
```

Drop unnecessary variables, /100 for percentage variables that haven't gotten that treatment already.
```{r}
library(tidyr)

# Drop columns that need log transformation therefore we cannot include with levels
region_year_data <- region_year_data[, !(names(region_year_data) %in% c("minwagevalue", "total_pop", "city_pop", "rural_pop", "avg_nominal_gross_wages", "lag_total_pop", "lag_city_pop", "lag_rural_pop", "lag_avg_nominal_gross_wages"))]

# Divide selected columns by 100
region_year_data[c("change_in_output", "change_in_real_avg_wages", "changeinindustrialproduction_all", 
                   "changeinindustrialproduction_mineral_extraction", "changeinindustrialproduction_manufacturing", 
                   "changeinindustrialproduction_electricity_utilities", "changeinindustrialproduction_water_utilities", 
                   "lag_changeinindustrialproduction_mineral_extraction", "lag_changeinindustrialproduction_manufacturing", 
                   "lag_changeinindustrialproduction_electricity_utilities", "lag_changeinindustrialproduction_water_utilities")] <- 
  region_year_data[c("change_in_output", "change_in_real_avg_wages", "changeinindustrialproduction_all", 
                     "changeinindustrialproduction_mineral_extraction", "changeinindustrialproduction_manufacturing", 
                     "changeinindustrialproduction_electricity_utilities", "changeinindustrialproduction_water_utilities", 
                     "lag_changeinindustrialproduction_mineral_extraction", "lag_changeinindustrialproduction_manufacturing", 
                     "lag_changeinindustrialproduction_electricity_utilities", "lag_changeinindustrialproduction_water_utilities")] / 100

region_year_data %>%
  summarise(across(everything(), ~sum(is.na(.)))) %>%
  gather(key = "Column", value = "NA_Count") %>%
  filter(NA_Count > 0)

# Remove columns with missing first observations
region_year_data <- region_year_data[, !(names(region_year_data) %in% c("poverty_rate", "change_in_real_avg_wages", "log_minwagevalue", "lag_log_minwagevalue"))]

# Keep the original columns as-is (this part is already implicitly handled by not applying any transformation to the specified columns)
# You don't need to do anything for columns like "Region", "Year", "Outflow", "poverty_rate", etc.
```

Prep by removing NAs
```{r}
library(dplyr)

# Identify rows with NA values and return the Year, Region, and the variable(s) with NA
na_data <- region_year_data %>%
  tidyr::gather(key = "variable", value = "value", -Year, -Region) %>%
  filter(is.na(value)) %>%
  dplyr::select(Year, Region, variable)

# View the result
head(na_data) #No NAs left!
```

Prep by adding a post-war dummy. 
```{r}
region_year_data <- region_year_data %>%
  # Add the postwar dummy variable
  mutate(war = if_else(Year >= 2022, 1, 0)) %>%
  mutate(postwar = if_else(Year >= 2022, Year - 2021, 0)) 
```

Output folder
```{r}
output_directory <- "/Users/michelle/Documents/thesis/MODEL OUTPUT (w nowcasted series)/OUTFLOWS" 
```





#AD: Plain DID 

```{r}
region_year_data_copy <- region_year_data %>%
  dplyr::select(-mediazona) #needs to be logged only
region_year_data <- region_year_data %>%
  dplyr::select(-contains("mediazona"))
```

## A_X: No fixed effects (not really functional due to lack of predictors)

```{r}
# Load necessary libraries
library(lmtest)  # For coeftest function
library(sandwich) # For robust standard errors

# Create the formula for the model (Outflow as the dependent variable) without an intercept
formula <- as.formula(paste("log1p(Outflow) ~ ",   # Remove the intercept with "0 +"
                            paste(c("war", "postwar"), collapse = " + ")))  

# Fit the full model using all covariates and fixed effects
full_model <- lm(formula, data = region_year_data)

# Obtain robust standard errors
robust_se <- vcovHC(full_model, type = "HC3")  # HC3 for robust SE

# Get the summary with robust standard errors
robust_summary <- coeftest(full_model, vcov = robust_se)  # Robust errors

# Compare standard vs. robust results
summary(full_model) # Standard errors
print(robust_summary) # Robust errors
```

```{r}
# 1. Breusch-Pagan test for heteroskedasticity
library(lmtest)
bptest(full_model, studentize = TRUE)
bptest(full_model, studentize = FALSE)

# 2. Residual plot
# Plot residuals vs fitted values to visually inspect for heteroskedasticity
plot(full_model$fitted.values, full_model$residuals, 
     main = "Residual Plot (Model 1A)", 
     xlab = "Fitted Values", 
     ylab = "Residuals", 
     pch = 16, col = "blue")
abline(h = 0, col = "red", lwd = 2)

# Optional: To further check for heteroskedasticity, you can use a scale-location plot
plot(full_model, which = 3)
```

```{r save}
model_name <- "A_X"  # Replace this with your model name or identifier

# Save the standard summary output of the stepwise model
summary_file <- file.path(output_directory, paste0(model_name, "_summary_", ".txt"))
capture.output(summary(full_model), file = summary_file)

# Save the robust summary output with robust standard errors
robust_summary_file <- file.path(output_directory, paste0(model_name, "_robust_summary_", ".txt"))
capture.output(print(robust_summary), file = robust_summary_file)

# Print out the file locations for confirmation
cat("Files saved to:\n")
cat("Model Summary: ", summary_file, "\n")
cat("Robust Summary: ", robust_summary_file, "\n")
```


## A_FE: With fixed effects (not really functional due to overfit)

```{r}
# Load necessary libraries
library(clubSandwich)
library(lmtest)  # For coeftest function

# Create the formula for the model (Outflow as the dependent variable) without an intercept
formula <- as.formula(paste("log1p(Outflow) ~ 0 +",   # Remove the intercept with "0 +"
                            paste(c("war", "postwar", "factor(Region)"), collapse = " + ")))  

# Fit the full model using all covariates and fixed effects
full_model <- lm(formula, data = region_year_data)

# Obtain robust standard errors
robust_se <- vcovHC(full_model, type = "HC3")  # HC3 for robust SE

# Get the summary with robust standard errors
robust_summary <- coeftest(full_model, vcov = robust_se)  # Robust errors

# Compare standard vs. robust results
print(summary(full_model))  # Standard errors
print(robust_summary) # Robust errors

# Extract and print Adjusted R-squared and F-statistic from the summary
adj_r_squared <- summary(full_model)$adj.r.squared
f_stat <- summary(full_model)$fstatistic

cat("Adjusted R-squared: ", adj_r_squared, "\n")
cat("F-statistic: ", f_stat[1], " on ", f_stat[2], " and ", f_stat[3], " DF \n")
```

```{r}
# 1. Breusch-Pagan test for heteroskedasticity
library(lmtest)
bptest(full_model, studentize = TRUE)
bptest(full_model, studentize = FALSE)

# 2. Residual plot
# Plot residuals vs fitted values to visually inspect for heteroskedasticity
plot(full_model$fitted.values, full_model$residuals, 
     main = "Residual Plot (Model 1A)", 
     xlab = "Fitted Values", 
     ylab = "Residuals", 
     pch = 16, col = "blue")
abline(h = 0, col = "red", lwd = 2)

# Optional: To further check for heteroskedasticity, you can use a scale-location plot
plot(full_model, which = 3)
```

```{r save}
model_name <- "A_FE"

# Save the standard summary output of the stepwise model
summary_file <- file.path(output_directory, paste0(model_name, "_summary_", ".txt"))
capture.output(summary(full_model), file = summary_file)

# Save the robust summary output with robust standard errors
robust_summary_file <- file.path(output_directory, paste0(model_name, "_robust_summary_", ".txt"))
capture.output(print(robust_summary), file = robust_summary_file)

# Print out the file locations for confirmation
cat("Files saved to:\n")
cat("Model Summary: ", summary_file, "\n")
cat("Robust Summary: ", robust_summary_file, "\n")
```


#BD: DID with covariates

##B_X_BIC: NO fixed effects + BIC

```{r}
# Load necessary libraries
library(sandwich)  # For robust standard errors
library(lmtest)    # For coeftest function

# Create the formula for the model (Outflow as the dependent variable)
formula <- as.formula(paste("log1p(Outflow) ~ ",  
                            paste(names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))], collapse = " + ")))

full_model <- lm(formula, data = region_year_data)

# Note: We specify k = log(n) to use BIC instead of AIC
stepwise_model <- step(full_model, direction = "both", k = log(nrow(region_year_data)), trace = 1)

# Obtain robust standard errors
robust_se <- vcovHC(stepwise_model, type = "HC3")  # HC3 for robust SE

# Get the summary with robust standard errors
robust_summary <- coeftest(stepwise_model, vcov = robust_se)  # Robust errors

# Compare standard vs. robust results
print(summary(stepwise_model)) # Standard errors
print(robust_summary) # Robust errors

# Extract and print Adjusted R-squared and F-statistic from the summary
adj_r_squared <- summary(stepwise_model)$adj.r.squared
f_stat <- summary(stepwise_model)$fstatistic

cat("Adjusted R-squared: ", adj_r_squared, "\n")
cat("F-statistic: ", f_stat[1], " on ", f_stat[2], " and ", f_stat[3], " DF \n")
```

```{r}
# 1. Breusch-Pagan test for heteroskedasticity
library(lmtest)
bptest(stepwise_model, studentize = TRUE)
bptest(stepwise_model, studentize = FALSE)

# 2. Residual plot
# Plot residuals vs fitted values to visually inspect for heteroskedasticity
plot(stepwise_model$fitted.values, stepwise_model$residuals, 
     main = "Residual Plot (Model 1B)", 
     xlab = "Fitted Values", 
     ylab = "Residuals", 
     pch = 16, col = "blue")
abline(h = 0, col = "red", lwd = 2)

# Optional: To further check for heteroskedasticity, you can use a scale-location plot
plot(stepwise_model, which = 3)
```

```{r save}
model_name <- "B_X_BIC"

# Save the standard summary output of the stepwise model
summary_file <- file.path(output_directory, paste0(model_name, "_summary_", ".txt"))
capture.output(summary(stepwise_model), file = summary_file)

# Save the robust summary output with robust standard errors
robust_summary_file <- file.path(output_directory, paste0(model_name, "_robust_summary_", ".txt"))
capture.output(print(robust_summary), file = robust_summary_file)

# Identify all potential covariates (excluding 'Region', 'Year', and 'Outflow')
all_covariates <- names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))]
selected_covariates <- names(coef(stepwise_model))[-1]  # Exclude intercept
non_selected_covariates <- setdiff(all_covariates, selected_covariates)
non_selected_file <- file.path(output_directory, paste0(model_name, "_non_selected_covariates.txt"))
capture.output(cat("Non-selected covariates:\n", paste(non_selected_covariates, collapse = ", "), "\n"),
               file = non_selected_file)

# Print out the file locations for confirmation
cat("Files saved to:\n")
cat("Model Summary: ", summary_file, "\n")
cat("Robust Summary: ", robust_summary_file, "\n")
cat("Non-selected covariates saved to:", non_selected_file, "\n")
```


##B_FE_BIC: With fixed effects + BIC

```{r}
# Load necessary libraries
library(sandwich)  # For robust standard errors
library(lmtest)    # For coeftest function

# Prepare the data (remove unwanted columns)
region_year_data <- region_year_data %>% 
  dplyr::select(-contains("mediazona"))

# Create the formula for the model (Outflow as the dependent variable)
formula <- as.formula(paste("log1p(Outflow) ~ ",  
                            paste(names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))], collapse = " + "),  
                            "+ factor(Region)"))

full_model <- lm(formula, data = region_year_data)

# Note: We specify k = log(n) to use BIC instead of AIC
stepwise_model <- step(full_model, direction = "both", k = log(nrow(region_year_data)), trace = 1)

# Obtain robust standard errors
robust_se <- vcovHC(stepwise_model, type = "HC3")  # HC3 for robust SE

# Get the summary with robust standard errors
robust_summary <- coeftest(stepwise_model, vcov = robust_se)  # Robust errors

# Compare standard vs. robust results
print(summary(stepwise_model))  # Standard errors
print(robust_summary) # Robust errors

# Extract and print Adjusted R-squared and F-statistic from the summary
adj_r_squared <- summary(stepwise_model)$adj.r.squared
f_stat <- summary(stepwise_model)$fstatistic

cat("Adjusted R-squared: ", adj_r_squared, "\n")
cat("F-statistic: ", f_stat[1], " on ", f_stat[2], " and ", f_stat[3], " DF \n")
```

```{r}
# 1. Breusch-Pagan test for heteroskedasticity
library(lmtest)
bptest(stepwise_model, studentize = TRUE)
bptest(stepwise_model, studentize = FALSE)

# 2. Residual plot
# Plot residuals vs fitted values to visually inspect for heteroskedasticity
plot(stepwise_model$fitted.values, stepwise_model$residuals, 
     main = "Residual Plot (Model 1B)", 
     xlab = "Fitted Values", 
     ylab = "Residuals", 
     pch = 16, col = "blue")
abline(h = 0, col = "red", lwd = 2)

# Optional: To further check for heteroskedasticity, you can use a scale-location plot
plot(stepwise_model, which = 3)
```

```{r save}
model_name <- "B_FE_BIC"

# Save the standard summary output of the stepwise model
summary_file <- file.path(output_directory, paste0(model_name, "_summary_", ".txt"))
capture.output(summary(stepwise_model), file = summary_file)

# Save the robust summary output with robust standard errors
robust_summary_file <- file.path(output_directory, paste0(model_name, "_robust_summary_", ".txt"))
capture.output(print(robust_summary), file = robust_summary_file)

# Identify all potential covariates (excluding 'Region', 'Year', and 'Outflow')
all_covariates <- names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))]
selected_covariates <- names(coef(stepwise_model))[-1]  # Exclude intercept
non_selected_covariates <- setdiff(all_covariates, selected_covariates)
non_selected_file <- file.path(output_directory, paste0(model_name, "_non_selected_covariates.txt"))
capture.output(cat("Non-selected covariates:\n", paste(non_selected_covariates, collapse = ", "), "\n"),
               file = non_selected_file)

# Print out the file locations for confirmation
cat("Files saved to:\n")
cat("Model Summary: ", summary_file, "\n")
cat("Robust Summary: ", robust_summary_file, "\n")
cat("Non-selected covariates saved to:", non_selected_file, "\n")
```


##B_X_AIC: NO fixed effects + AIC

```{r}
# Load necessary libraries
library(sandwich)  # For robust standard errors
library(lmtest)    # For coeftest function

# Create the formula for the model (Outflow as the dependent variable)
formula <- as.formula(paste("log1p(Outflow) ~ ",  
                            paste(names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))], collapse = " + ")))

full_model <- lm(formula, data = region_year_data)

# Note: We specify k = log(n) to use BIC instead of AIC
stepwise_model <- step(full_model, direction = "both", trace = 1)

# Obtain robust standard errors
robust_se <- vcovHC(stepwise_model, type = "HC3")  # HC3 for robust SE

# Get the summary with robust standard errors
robust_summary <- coeftest(stepwise_model, vcov = robust_se)  # Robust errors

# Compare standard vs. robust results
print(summary(stepwise_model)) # Standard errors
print(robust_summary) # Robust errors

# Extract and print Adjusted R-squared and F-statistic from the summary
adj_r_squared <- summary(stepwise_model)$adj.r.squared
f_stat <- summary(stepwise_model)$fstatistic

cat("Adjusted R-squared: ", adj_r_squared, "\n")
cat("F-statistic: ", f_stat[1], " on ", f_stat[2], " and ", f_stat[3], " DF \n")
```

```{r}
# 1. Breusch-Pagan test for heteroskedasticity
library(lmtest)
bptest(stepwise_model, studentize = TRUE)
bptest(stepwise_model, studentize = FALSE)

# 2. Residual plot
# Plot residuals vs fitted values to visually inspect for heteroskedasticity
plot(stepwise_model$fitted.values, stepwise_model$residuals, 
     main = "Residual Plot (Model 1B)", 
     xlab = "Fitted Values", 
     ylab = "Residuals", 
     pch = 16, col = "blue")
abline(h = 0, col = "red", lwd = 2)

# Optional: To further check for heteroskedasticity, you can use a scale-location plot
plot(stepwise_model, which = 3)
```

```{r save}
model_name <- "B_X_AIC"

# Save the standard summary output of the stepwise model
summary_file <- file.path(output_directory, paste0(model_name, "_summary_", ".txt"))
capture.output(summary(stepwise_model), file = summary_file)

# Save the robust summary output with robust standard errors
robust_summary_file <- file.path(output_directory, paste0(model_name, "_robust_summary_", ".txt"))
capture.output(print(robust_summary), file = robust_summary_file)

# Identify all potential covariates (excluding 'Region', 'Year', and 'Outflow')
all_covariates <- names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))]
selected_covariates <- names(coef(stepwise_model))[-1]  # Exclude intercept
non_selected_covariates <- setdiff(all_covariates, selected_covariates)
non_selected_file <- file.path(output_directory, paste0(model_name, "_non_selected_covariates.txt"))
capture.output(cat("Non-selected covariates:\n", paste(non_selected_covariates, collapse = ", "), "\n"),
               file = non_selected_file)

# Print out the file locations for confirmation
cat("Files saved to:\n")
cat("Model Summary: ", summary_file, "\n")
cat("Robust Summary: ", robust_summary_file, "\n")
cat("Non-selected covariates saved to:", non_selected_file, "\n")
```


##B_FE_AIC: With fixed effects + AIC

```{r}
# Load necessary libraries
library(sandwich)  # For robust standard errors
library(lmtest)    # For coeftest function

# Prepare the data (remove unwanted columns)
region_year_data <- region_year_data %>% 
  dplyr::select(-contains("mediazona"))

# Create the formula for the model (Outflow as the dependent variable)
formula <- as.formula(paste("log1p(Outflow) ~ ",  
                            paste(names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))], collapse = " + "),  
                            "+ factor(Region)"))

full_model <- lm(formula, data = region_year_data)

# Note: We specify k = log(n) to use BIC instead of AIC
stepwise_model <- step(full_model, direction = "both", trace = 1)

# Obtain robust standard errors
robust_se <- vcovHC(stepwise_model, type = "HC3")  # HC3 for robust SE

# Get the summary with robust standard errors
robust_summary <- coeftest(stepwise_model, vcov = robust_se)  # Robust errors

# Compare standard vs. robust results
print(summary(stepwise_model))  # Standard errors
print(robust_summary) # Robust errors

# Extract and print Adjusted R-squared and F-statistic from the summary
adj_r_squared <- summary(stepwise_model)$adj.r.squared
f_stat <- summary(stepwise_model)$fstatistic

cat("Adjusted R-squared: ", adj_r_squared, "\n")
cat("F-statistic: ", f_stat[1], " on ", f_stat[2], " and ", f_stat[3], " DF \n")
```

```{r}
# 1. Breusch-Pagan test for heteroskedasticity
library(lmtest)
bptest(stepwise_model, studentize = TRUE)
bptest(stepwise_model, studentize = FALSE)

# 2. Residual plot
# Plot residuals vs fitted values to visually inspect for heteroskedasticity
plot(stepwise_model$fitted.values, stepwise_model$residuals, 
     main = "Residual Plot (Model 1B)", 
     xlab = "Fitted Values", 
     ylab = "Residuals", 
     pch = 16, col = "blue")
abline(h = 0, col = "red", lwd = 2)

# Optional: To further check for heteroskedasticity, you can use a scale-location plot
plot(stepwise_model, which = 3)
```

```{r save}
model_name <- "B_FE_AIC"

# Save the standard summary output of the stepwise model
summary_file <- file.path(output_directory, paste0(model_name, "_summary_", ".txt"))
capture.output(summary(stepwise_model), file = summary_file)

# Save the robust summary output with robust standard errors
robust_summary_file <- file.path(output_directory, paste0(model_name, "_robust_summary_", ".txt"))
capture.output(print(robust_summary), file = robust_summary_file)

# Identify all potential covariates (excluding 'Region', 'Year', and 'Outflow')
all_covariates <- names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))]
selected_covariates <- names(coef(stepwise_model))[-1]  # Exclude intercept
non_selected_covariates <- setdiff(all_covariates, selected_covariates)
non_selected_file <- file.path(output_directory, paste0(model_name, "_non_selected_covariates.txt"))
capture.output(cat("Non-selected covariates:\n", paste(non_selected_covariates, collapse = ", "), "\n"),
               file = non_selected_file)

# Print out the file locations for confirmation
cat("Files saved to:\n")
cat("Model Summary: ", summary_file, "\n")
cat("Robust Summary: ", robust_summary_file, "\n")
cat("Non-selected covariates saved to:", non_selected_file, "\n")
```



#CD: DID adding Mediazona casualties (labor substitution analysis)
We simply add mediazona data back into the mix and see if it is selected and what its coefficients look like. 

```{r prep}
region_year_data <- region_year_data_copy
```

##C_X_BIC: NO fixed effects + BIC

```{r}
# Load necessary libraries
library(sandwich)  # For robust standard errors
library(lmtest)    # For coeftest function

# Create the formula for the model (Outflow as the dependent variable)
formula <- as.formula(paste("log1p(Outflow) ~ ",  
                            paste(names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))], collapse = " + ")))

full_model <- lm(formula, data = region_year_data)

# Note: We specify k = log(n) to use BIC instead of AIC
stepwise_model <- step(full_model, direction = "both", k = log(nrow(region_year_data)), trace = 1)

# Obtain robust standard errors
robust_se <- vcovHC(stepwise_model, type = "HC3")  # HC3 for robust SE

# Get the summary with robust standard errors
robust_summary <- coeftest(stepwise_model, vcov = robust_se)  # Robust errors

# Compare standard vs. robust results
print(summary(stepwise_model)) # Standard errors
print(robust_summary) # Robust errors

# Extract and print Adjusted R-squared and F-statistic from the summary
adj_r_squared <- summary(stepwise_model)$adj.r.squared
f_stat <- summary(stepwise_model)$fstatistic

cat("Adjusted R-squared: ", adj_r_squared, "\n")
cat("F-statistic: ", f_stat[1], " on ", f_stat[2], " and ", f_stat[3], " DF \n")
```

```{r}
# 1. Breusch-Pagan test for heteroskedasticity
library(lmtest)
bptest(stepwise_model, studentize = TRUE)
bptest(stepwise_model, studentize = FALSE)

# 2. Residual plot
# Plot residuals vs fitted values to visually inspect for heteroskedasticity
plot(stepwise_model$fitted.values, stepwise_model$residuals, 
     main = "Residual Plot (Model 1B)", 
     xlab = "Fitted Values", 
     ylab = "Residuals", 
     pch = 16, col = "blue")
abline(h = 0, col = "red", lwd = 2)

# Optional: To further check for heteroskedasticity, you can use a scale-location plot
plot(stepwise_model, which = 3)
```

```{r save}
model_name <- "C_X_BIC"

# Save the standard summary output of the stepwise model
summary_file <- file.path(output_directory, paste0(model_name, "_summary_", ".txt"))
capture.output(summary(stepwise_model), file = summary_file)

# Save the robust summary output with robust standard errors
robust_summary_file <- file.path(output_directory, paste0(model_name, "_robust_summary_", ".txt"))
capture.output(print(robust_summary), file = robust_summary_file)

# Identify all potential covariates (excluding 'Region', 'Year', and 'Outflow')
all_covariates <- names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))]
selected_covariates <- names(coef(stepwise_model))[-1]  # Exclude intercept
non_selected_covariates <- setdiff(all_covariates, selected_covariates)
non_selected_file <- file.path(output_directory, paste0(model_name, "_non_selected_covariates.txt"))
capture.output(cat("Non-selected covariates:\n", paste(non_selected_covariates, collapse = ", "), "\n"),
               file = non_selected_file)

# Print out the file locations for confirmation
cat("Files saved to:\n")
cat("Model Summary: ", summary_file, "\n")
cat("Robust Summary: ", robust_summary_file, "\n")
cat("Non-selected covariates saved to:", non_selected_file, "\n")
```

##C_FE_BIC: With fixed effects + BIC

```{r}
# Load necessary libraries
library(sandwich)  # For robust standard errors
library(lmtest)    # For coeftest function

# Create the formula for the model (Outflow as the dependent variable)
formula <- as.formula(paste("log1p(Outflow) ~ ",  
                            paste(names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))], collapse = " + "),  
                            "+ factor(Region)"))

full_model <- lm(formula, data = region_year_data)

# Note: We specify k = log(n) to use BIC instead of AIC
stepwise_model <- step(full_model, direction = "both", k = log(nrow(region_year_data)), trace = 1)

# Obtain robust standard errors
robust_se <- vcovHC(stepwise_model, type = "HC3")  # HC3 for robust SE

# Get the summary with robust standard errors
robust_summary <- coeftest(stepwise_model, vcov = robust_se)  # Robust errors

# Compare standard vs. robust results
print(summary(stepwise_model))  # Standard errors
print(robust_summary) # Robust errors

# Extract and print Adjusted R-squared and F-statistic from the summary
adj_r_squared <- summary(stepwise_model)$adj.r.squared
f_stat <- summary(stepwise_model)$fstatistic

cat("Adjusted R-squared: ", adj_r_squared, "\n")
cat("F-statistic: ", f_stat[1], " on ", f_stat[2], " and ", f_stat[3], " DF \n")
```

```{r}
# 1. Breusch-Pagan test for heteroskedasticity
library(lmtest)
bptest(stepwise_model, studentize = TRUE)
bptest(stepwise_model, studentize = FALSE)

# 2. Residual plot
# Plot residuals vs fitted values to visually inspect for heteroskedasticity
plot(stepwise_model$fitted.values, stepwise_model$residuals, 
     main = "Residual Plot (Model 1B)", 
     xlab = "Fitted Values", 
     ylab = "Residuals", 
     pch = 16, col = "blue")
abline(h = 0, col = "red", lwd = 2)

# Optional: To further check for heteroskedasticity, you can use a scale-location plot
plot(stepwise_model, which = 3)
```

```{r save}
model_name <- "C_FE_BIC"

# Save the standard summary output of the stepwise model
summary_file <- file.path(output_directory, paste0(model_name, "_summary_", ".txt"))
capture.output(summary(stepwise_model), file = summary_file)

# Save the robust summary output with robust standard errors
robust_summary_file <- file.path(output_directory, paste0(model_name, "_robust_summary_", ".txt"))
capture.output(print(robust_summary), file = robust_summary_file)

# Identify all potential covariates (excluding 'Region', 'Year', and 'Outflow')
all_covariates <- names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))]
selected_covariates <- names(coef(stepwise_model))[-1]  # Exclude intercept
non_selected_covariates <- setdiff(all_covariates, selected_covariates)
non_selected_file <- file.path(output_directory, paste0(model_name, "_non_selected_covariates.txt"))
capture.output(cat("Non-selected covariates:\n", paste(non_selected_covariates, collapse = ", "), "\n"),
               file = non_selected_file)

# Print out the file locations for confirmation
cat("Files saved to:\n")
cat("Model Summary: ", summary_file, "\n")
cat("Robust Summary: ", robust_summary_file, "\n")
cat("Non-selected covariates saved to:", non_selected_file, "\n")
```

##C_X_AIC: NO fixed effects + AIC

```{r}
# Load necessary libraries
library(sandwich)  # For robust standard errors
library(lmtest)    # For coeftest function

# Create the formula for the model (Outflow as the dependent variable)
formula <- as.formula(paste("log1p(Outflow) ~ ",  
                            paste(names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))], collapse = " + ")))

full_model <- lm(formula, data = region_year_data)

# Note: We specify k = log(n) to use BIC instead of AIC
stepwise_model <- step(full_model, direction = "both", trace = 1)

# Obtain robust standard errors
robust_se <- vcovHC(stepwise_model, type = "HC3")  # HC3 for robust SE

# Get the summary with robust standard errors
robust_summary <- coeftest(stepwise_model, vcov = robust_se)  # Robust errors

# Compare standard vs. robust results
print(summary(stepwise_model)) # Standard errors
print(robust_summary) # Robust errors

# Extract and print Adjusted R-squared and F-statistic from the summary
adj_r_squared <- summary(stepwise_model)$adj.r.squared
f_stat <- summary(stepwise_model)$fstatistic

cat("Adjusted R-squared: ", adj_r_squared, "\n")
cat("F-statistic: ", f_stat[1], " on ", f_stat[2], " and ", f_stat[3], " DF \n")
```

```{r}
# 1. Breusch-Pagan test for heteroskedasticity
library(lmtest)
bptest(stepwise_model, studentize = TRUE)
bptest(stepwise_model, studentize = FALSE)

# 2. Residual plot
# Plot residuals vs fitted values to visually inspect for heteroskedasticity
plot(stepwise_model$fitted.values, stepwise_model$residuals, 
     main = "Residual Plot (Model 1B)", 
     xlab = "Fitted Values", 
     ylab = "Residuals", 
     pch = 16, col = "blue")
abline(h = 0, col = "red", lwd = 2)

# Optional: To further check for heteroskedasticity, you can use a scale-location plot
plot(stepwise_model, which = 3)
```

```{r save}
model_name <- "C_X_AIC"

# Save the standard summary output of the stepwise model
summary_file <- file.path(output_directory, paste0(model_name, "_summary_", ".txt"))
capture.output(summary(stepwise_model), file = summary_file)

# Save the robust summary output with robust standard errors
robust_summary_file <- file.path(output_directory, paste0(model_name, "_robust_summary_", ".txt"))
capture.output(print(robust_summary), file = robust_summary_file)

# Identify all potential covariates (excluding 'Region', 'Year', and 'Outflow')
all_covariates <- names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))]
selected_covariates <- names(coef(stepwise_model))[-1]  # Exclude intercept
non_selected_covariates <- setdiff(all_covariates, selected_covariates)
non_selected_file <- file.path(output_directory, paste0(model_name, "_non_selected_covariates.txt"))
capture.output(cat("Non-selected covariates:\n", paste(non_selected_covariates, collapse = ", "), "\n"),
               file = non_selected_file)

# Print out the file locations for confirmation
cat("Files saved to:\n")
cat("Model Summary: ", summary_file, "\n")
cat("Robust Summary: ", robust_summary_file, "\n")
cat("Non-selected covariates saved to:", non_selected_file, "\n")
```

##C_FE_AIC: With fixed effects + AIC

```{r}
# Load necessary libraries
library(sandwich)  # For robust standard errors
library(lmtest)    # For coeftest function

# Create the formula for the model (Outflow as the dependent variable)
formula <- as.formula(paste("log1p(Outflow) ~ ",  
                            paste(names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))], collapse = " + "),  
                            "+ factor(Region)"))

full_model <- lm(formula, data = region_year_data)

# Note: We specify k = log(n) to use BIC instead of AIC
stepwise_model <- step(full_model, direction = "both", trace = 1)

# Obtain robust standard errors
robust_se <- vcovHC(stepwise_model, type = "HC3")  # HC3 for robust SE

# Get the summary with robust standard errors
robust_summary <- coeftest(stepwise_model, vcov = robust_se)  # Robust errors

# Compare standard vs. robust results
print(summary(stepwise_model))  # Standard errors
print(robust_summary) # Robust errors

# Extract and print Adjusted R-squared and F-statistic from the summary
adj_r_squared <- summary(stepwise_model)$adj.r.squared
f_stat <- summary(stepwise_model)$fstatistic

cat("Adjusted R-squared: ", adj_r_squared, "\n")
cat("F-statistic: ", f_stat[1], " on ", f_stat[2], " and ", f_stat[3], " DF \n")
```

```{r}
# 1. Breusch-Pagan test for heteroskedasticity
library(lmtest)
bptest(stepwise_model, studentize = TRUE)
bptest(stepwise_model, studentize = FALSE)

# 2. Residual plot
# Plot residuals vs fitted values to visually inspect for heteroskedasticity
plot(stepwise_model$fitted.values, stepwise_model$residuals, 
     main = "Residual Plot (Model 1B)", 
     xlab = "Fitted Values", 
     ylab = "Residuals", 
     pch = 16, col = "blue")
abline(h = 0, col = "red", lwd = 2)

# Optional: To further check for heteroskedasticity, you can use a scale-location plot
plot(stepwise_model, which = 3)
```

```{r save}
model_name <- "C_FE_AIC"

# Save the standard summary output of the stepwise model
summary_file <- file.path(output_directory, paste0(model_name, "_summary_", ".txt"))
capture.output(summary(stepwise_model), file = summary_file)

# Save the robust summary output with robust standard errors
robust_summary_file <- file.path(output_directory, paste0(model_name, "_robust_summary_", ".txt"))
capture.output(print(robust_summary), file = robust_summary_file)

# Identify all potential covariates (excluding 'Region', 'Year', and 'Outflow')
all_covariates <- names(region_year_data)[!(names(region_year_data) %in% c('Region', 'Year', 'Outflow'))]
selected_covariates <- names(coef(stepwise_model))[-1]  # Exclude intercept
non_selected_covariates <- setdiff(all_covariates, selected_covariates)
non_selected_file <- file.path(output_directory, paste0(model_name, "_non_selected_covariates.txt"))
capture.output(cat("Non-selected covariates:\n", paste(non_selected_covariates, collapse = ", "), "\n"),
               file = non_selected_file)

# Print out the file locations for confirmation
cat("Files saved to:\n")
cat("Model Summary: ", summary_file, "\n")
cat("Robust Summary: ", robust_summary_file, "\n")
cat("Non-selected covariates saved to:", non_selected_file, "\n")
```


