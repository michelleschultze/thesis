This file will be used to load in monthly data, merge them, produce dummies, 
and then run a 3-step AIC/BIC analysis like with the other models.

## Prepwork

Packages
```{r}
library(readxl)
library(tidyverse)
library(lubridate)
library(dplyr)
library(sandwich)  # For robust standard errors
library(lmtest)     # For coeftest to display robust SEs
library(caret)
library(MASS)
library(stargazer)
```

Data load in
```{r}
setwd("/Users/michelle/")
vertdata <- read_excel("Documents/thesis/Macrodata/Cleaned macrodata (intermediate)/MONTHLY COVARIATES.xlsx", 
    sheet = "vertical")
horizdata <- read_excel("Documents/thesis/Macrodata/Cleaned macrodata (intermediate)/MONTHLY COVARIATES.xlsx", 
    sheet = "horizontal")
```

Merge horizontal/vertical covariates
```{r}
vertdata <- vertdata %>%
  mutate(across(where(is.character), ~ as.numeric(.))) %>%  # Convert character columns to numeric
  pivot_longer(
    cols = -Month,  # Keep "Month" column fixed
    names_to = "Variable",  # Create a new column "Variable" for the column names
    values_to = "Value"  # Create a new column "Value" for the values
  )

horizdata <- horizdata %>%
  rename(Variable = Month) %>%  # Rename "Month" to something more descriptive
  pivot_longer(
    cols = -Variable,   # Keep the "Category" column fixed
    names_to = "ExcelDate",  
    values_to = "Value"  
  ) %>%
  mutate(
    ExcelDate = as.numeric(ExcelDate),  # Convert column names to numeric
    Date = as.Date(ExcelDate, origin = "1899-12-30"),  # Convert Excel serial to proper date
    Month = format(Date, "%Y-%m")  # Extract Year-Month
  ) %>%
  dplyr::select(Month, Variable, Value)  # Keep only useful columns

vertdata <- vertdata %>%
  mutate(
    Month = format(as.Date(Month), "%Y-%m")  # Convert to Year-Month format
  ) %>%
  dplyr::select(Month, Variable, Value)  # Keep only relevant columns

fulldata <- dplyr::bind_rows(horizdata, vertdata)

fulldata %>%
  dplyr::count(Month, Variable) %>%
  dplyr::filter(n > 1)

# Check for duplicates based on the combination of Month and Variable
fulldata %>%
  group_by(Month, Variable) %>%
  summarise(n = n()) %>%  # Count the occurrences of each (Month, Variable) pair
  filter(n > 1)  # Filter for those with more than one occurrence
```

Adding TGE covariates and removing some duplicates
```{r}
library(readr)
TGE_monthly_df <- read_csv("Documents/thesis/Macrodata/Cleaned macrodata (intermediate)/TGE_monthly_df.csv")

TGE_monthly_df <- TGE_monthly_df %>%
  mutate(Month = sprintf("%04d-%02d", Year, Month))

TGE_monthly_df <- TGE_monthly_df %>%
  mutate(
    Variable = gsub(" ", "_", Variable),  # Replace spaces with underscores
    Variable = paste0(Variable, "_", ifelse(Country == "Kyrgyzstan", "KGZ", "RUS"))  # Append "_KGZ" or "_RUS"
  )

TGE_monthly_df <- TGE_monthly_df %>%
  dplyr::select(Month, Variable, Value)

# Optional: Check the structure of both dataframes to ensure consistency
str(TGE_monthly_df)
str(fulldata)

fulldata <- bind_rows(TGE_monthly_df, fulldata)
```

Pivot wider
```{r}
fulldata <- fulldata %>%
  pivot_wider(
    names_from = Variable,  # Each unique value in 'Variable' becomes a column
    values_from = Value     # Fill those columns with values from 'Value'
  )
```

Generate new dummies
```{r}
# Assuming `Month` is a datetime column or character column, we convert it to Date format first
# Convert 'Month' to Date format
# Convert 'Month' to Date format
fulldata <- fulldata %>%
  mutate(
    Month = as.Date(paste(Month, "01", sep = "-")),  # Convert to Date by appending '01' for day
    
    # War: 1 from February 2022 onward
    war = if_else(Month >= as.Date("2022-02-01"), 1, 0),
    
    # Post-war: Counts up from 0 starting from February 2022
    post_war = coalesce(if_else(Month >= as.Date("2022-02-01"), as.numeric(difftime(Month, as.Date("2022-02-24"), units = "days")), NA_real_), 0),
    
    # Crocus: 1 from March 2024 onward
    crocus = if_else(Month >= as.Date("2024-03-01"), 1, 0),
    
    # Post-crocus: Counts up from 0 starting from March 2024
    post_crocus = coalesce(if_else(Month >= as.Date("2024-03-01"), as.numeric(difftime(Month, as.Date("2024-03-22"), units = "days")), NA_real_), 0)
  )

fulldata <- fulldata %>%
  mutate(
    # Replace NAs in the 'eid' column with 0
    Ramadan_starts = coalesce(Ramadan_starts, 0),
    Eid_al_Adha = coalesce(Eid_al_Adha, 0),
    Eid_al_Fitr = coalesce(Eid_al_Fitr, 0)
  )

# Create the COVID dummy variable
fulldata <- fulldata %>%
  mutate(
    covid = if_else(Month >= as.Date("2020-03-01") & Month <= as.Date("2021-03-01"), 1, 0)
  )

# Create monthly dummies based on the unique months
fulldata <- fulldata %>%
  mutate(
    # Extract the month from 'Month' (assuming it's in the 'YYYY-MM' format)
    month_num = as.numeric(format(as.Date(Month, format = "%Y-%m"), "%m")),
    
    # Create dummy variables for each month (January to December)
    jan = if_else(month_num == 1, 1, 0),
    feb = if_else(month_num == 2, 1, 0),
    mar = if_else(month_num == 3, 1, 0),
    apr = if_else(month_num == 4, 1, 0),
    may = if_else(month_num == 5, 1, 0),
    jun = if_else(month_num == 6, 1, 0),
    jul = if_else(month_num == 7, 1, 0),
    aug = if_else(month_num == 8, 1, 0),
    sep = if_else(month_num == 9, 1, 0),
    oct = if_else(month_num == 10, 1, 0),
    nov = if_else(month_num == 11, 1, 0),
    dec = if_else(month_num == 12, 1, 0)
  ) %>%
  dplyr::select(-month_num)  # Optionally remove the intermediate 'month_num' column

# View the updated data
head(fulldata)

fulldata <- fulldata %>%
  mutate(time_trend = as.numeric(difftime(Month, min(Month), units = "weeks")) + 1)
```

## Just war effects + crocus dummy effects and NO seasonality

```{r}
# Step 1: Fit an initial linear model
model <- lm(log(Remittances_fromRus) ~ war + post_war + crocus + post_crocus + covid, 
   data = fulldata)

# Step 3: Compute robust standard errors using vcovHC
robust_se <- vcovHC(model, type = "HC1")

# Step 4: Display the results with robust standard errors
summary_robust <- coeftest(model, vcov = robust_se)
print(model)
print(summary_robust)
```

```{r}
library(ggplot2)

# Generate fitted values from the model
fulldata$predicted <- NA  # Initialize predicted column
fulldata$predicted <- predict(model, newdata = fulldata %>% drop_na(war, post_war, crocus, post_crocus))


# Plot the actual time series
ggplot(fulldata, aes(x = Month)) +
  geom_line(aes(y = Remittances_fromRus), color = "black", size = 1, alpha = 0.7) +  # Actual log remittances
  geom_line(aes(y = exp(predicted)), color = "red", size = 1, linetype = "dashed") +  # DID model prediction
  labs(title = "Time Series of Remittances with Double DID Model",
       x = "Month",
       y = "Remittances",
       caption = "Black: Actual | Red Dashed: DID Model") +
  theme_minimal()

```

## Just war effects + crocus dummy effects and monthly seasonality

```{r}
# Step 1: Fit an initial linear model
model <- lm(log(Remittances_fromRus) ~ war + post_war + crocus + post_crocus + covid +
     jan + feb + mar + apr + may + jun + jul + aug + sep + oct + nov + dec + time_trend - 1, 
   data = fulldata)

# Step 3: Compute robust standard errors using vcovHC
robust_se <- vcovHC(model, type = "HC1")

# Step 4: Display the results with robust standard errors
summary_robust <- coeftest(model, vcov = robust_se)
print(model)
print(summary_robust)
```

```{r}
library(ggplot2)

# Generate fitted values from the model
fulldata$predicted <- NA  # Initialize predicted column
fulldata$predicted <- predict(model, newdata = fulldata %>% drop_na(war, post_war, crocus, post_crocus))


# Plot the actual time series
ggplot(fulldata, aes(x = Month)) +
  geom_line(aes(y = Remittances_fromRus), color = "black", size = 1, alpha = 0.7) +  # Actual log remittances
  geom_line(aes(y = exp(predicted)), color = "red", size = 1, linetype = "dashed") +  # DID model prediction
  labs(title = "Time Series of Remittances with Double DID Model",
       x = "Month",
       y = "Remittances",
       caption = "Black: Actual | Red Dashed: DID Model") +
  theme_minimal()
```

## Adding in economic covariates: narrow it down first

Remove covariates that lack observations for the critical timeframe. 121 vars.
```{r}
fulldata_copy <- fulldata

tempset <- fulldata %>%
  filter(Month <= as.Date("2024-09-01") & Month >= as.Date("2011-01-01"))

na_columns <- colnames(tempset)[colSums(is.na(tempset)) > 0]
fulldata <- fulldata %>% dplyr::select(-all_of(na_columns))
na_columns
```

Find percentage variables
```{r}
fulldata <- fulldata %>%
  dplyr::select(-predicted)

# Find columns that fluctuate between 50 and 150 or have "_pct_" in their name
percentage_columns <- fulldata %>%
  select_if(is.numeric) %>%
  summarise_all(~ all(. >= 70 & . <= 150, na.rm = TRUE)) %>%
  gather() %>%
  filter(value == TRUE) %>%
  pull(key) #these are all exchange rates, which we DO want to log. 

# Add columns that have "_pct_" in their name
pct_columns_by_percent <- grep("percent", colnames(fulldata), value = TRUE)
pct_columns_by_rate <- grep("rate", colnames(fulldata), value = TRUE)
pct_columns_by_ratio <- grep("ratio", colnames(fulldata), value = TRUE)

# Combine both sets of percentage columns
all_percentage_columns <- unique(c(pct_columns_by_percent, pct_columns_by_rate, pct_columns_by_ratio)) 

shouldbelogged <- c("Foreign_exchange_reserves_billion_currency_units_KGZ", "USD_Exchange_rate_KGZ", "Foreign_exchange_reserves_billion_currency_units_RUS", "USD_Exchange_rate_RUS")

all_percentage_columns <- setdiff(all_percentage_columns, shouldbelogged)

# Print the list of columns designated as percentages
print(all_percentage_columns)

# Get the columns that are not percentage columns
non_percentage_columns <- setdiff(colnames(fulldata), all_percentage_columns)

# Filter out the rows where values in these columns exceed 1
levels_variables <- fulldata %>% 
  dplyr::select(non_percentage_columns) %>% 
  summarise_all(~ sum(. > 1, na.rm = TRUE)) %>%
  gather(variable, count) %>%
  filter(count > 0)

print(levels_variables, n=1000)

# Define the variables to exclude
exclude_variables <- c(
  "post_war", "post_crocus", "time_trend", "Month", 
  "commbanks_loans_to_deposits_foreign_currency_KGZ", 
  "commbanks_loan_loss_provision_KGZ", "Ramadan_starts", 
  "Eid_al_Fitr", "Eid_al_Adha", "war", "crocus", "covid", 
  "jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", 
  "sep", "oct", "nov", "dec"
)

# Remove the specified variables from the levels_variables list
levels_variables_filtered <- setdiff(levels_variables$variable, exclude_variables)

# Print the remaining "levels" variables
print(levels_variables_filtered)

library(dplyr)

# Loop through each variable in levels_variables_filtered and check for values < 0
levels_variables_filtered <- levels_variables_filtered[sapply(levels_variables_filtered, function(var) {
  # Check if there are any values less than 0 in the column
  all(fulldata[[var]] >= 0, na.rm = TRUE)  # Return TRUE if all values are >= 0
})]

# Apply log transformation and rename variables
fulldata <- fulldata %>%
  mutate(across(all_of(levels_variables_filtered), 
                ~ log1p(.), 
                .names = "log_{.col}"))

fulldata <- fulldata %>%
  dplyr::select(-all_of(levels_variables_filtered))  # Remove original variables

# Print the updated dataframe column names to verify the transformation
print(colnames(fulldata))
```


BIG QUESTION: WHAT DO I WANT TO TEST?
- General trends: with month dummies / linear trend controlled for, does war have an effect?
- General trends: with month dummies / linear trend / war controlled for, does crocus have an effect?
- General trends: with month dummies / linear trend / war / crocus controlled for, does mediazona have an effect?
- With all econ covariates that won't interfere with the causal pipeline, add them that will clear out any effect associated with them.
--- don't use exchange rates, employment because they're all related to war... all covariates somehow affect war. let's just see how these work. 
--- USE inflation for KGZ and RUS to get a sense of real remittance values. level and change?
- log_Consumer_Price_Index_(CPI)_KGZ
- log_Consumer_Price_Index_(CPI)_RUS
- Inflation_monthly_percent_change_in_the_CPI_KGZ & Inflation_monthly_percent_change_in_the_CPI_RUS not needed because we only really care about controlling for price level, and this would be a mediator effect from war.

```{r}
fulldata <- fulldata %>%
  dplyr::select(Month, Ramadan_starts, Eid_al_Fitr, Eid_al_Adha, war, post_war, crocus, post_crocus, covid, jan, feb, mar, apr, may, jun, jul, aug, sep, oct, nov, dec, time_trend, log_Remittances_fromRus, log_mediazona, `log_Consumer_Price_Index_(CPI)_KGZ`, `log_Consumer_Price_Index_(CPI)_RUS`, log_KGZ_BRE_RUBLE, log_KGZ_REER_EAEU)
```

Lags
```{r}
excluded_vars <- c("log_Remittances_fromRus", "Ramadan_starts", 
                   "Eid_al_Fitr", "Eid_al_Adha", "war", "post_war", "crocus", 
                   "post_crocus", "covid", "jan", "feb", "mar", "apr", "may", 
                   "jun", "jul", "aug", "sep", "oct", "nov", "dec", "Month", "time_trend")

# Get a list of all the variable names in `fulldata`
all_vars <- colnames(fulldata)

# Filter out the variables that we don't want to lag
vars_to_lag <- setdiff(all_vars, excluded_vars)

# Create the lags for the variables in `vars_to_lag` using dplyr
library(dplyr)

fulldata_with_lags <- fulldata %>%
  arrange(Month) %>%
  mutate(across(all_of(vars_to_lag), list(lag1 = ~ lag(., 1)), .names = "{.col}_lag1"))

# Display the first few rows to verify
head(fulldata_with_lags)
```

Limit dates
```{r}
# Prep for industrialproduction-focused regression
fulldata_with_lags <- fulldata_with_lags %>% 
  filter(Month <= as.Date("2024-09-01")) %>%
  filter(Month >= as.Date("2011-01-01")) %>%
  dplyr::select(where(~ !any(is.na(.))))

#Factorize months
fulldata_with_lags$Month <- factor(format(fulldata_with_lags$Month, "%m"))
fulldata_with_lags <- fulldata_with_lags %>%
  mutate(Month = as.factor(Month))
  
#fulldata_with_lags <- fulldata_with_lags[, !(colnames(fulldata_with_lags) == "Month")]

fulldata_with_lags <- fulldata_with_lags %>%
  dplyr::select(-jan, -feb, -mar, -apr, -may, -jun, -jul, -aug, -sep, -oct, -nov, -dec, -time_trend)


fulldata_with_lags$log_mediazona_lag2 <- lag(fulldata_with_lags$log_mediazona, 2)
fulldata_with_lags$log_mediazona_lag3 <- lag(fulldata_with_lags$log_mediazona, 3)
fulldata_with_lags$log_mediazona_lag4 <- lag(fulldata_with_lags$log_mediazona, 4)
fulldata_with_lags$log_mediazona_lag5 <- lag(fulldata_with_lags$log_mediazona, 5)
fulldata_with_lags$log_mediazona_lag6 <- lag(fulldata_with_lags$log_mediazona, 6)
fulldata_with_lags$log_mediazona_lag7 <- lag(fulldata_with_lags$log_mediazona, 7)
fulldata_with_lags$log_mediazona_lag8 <- lag(fulldata_with_lags$log_mediazona, 8)

# Impute 0s for all NAs (it's just mediazona, which would be 0 because the war hadn't started yet)
fulldata_with_lags[is.na(fulldata_with_lags)] <- 0
```

Add correct time trend
```{r}
fulldata_with_lags <- fulldata_with_lags %>%
  mutate(time_trend = row_number())
```




# Reg 1 - basic

```{r}
# Load necessary libraries
library(sandwich)
library(lmtest)

initial_model <- lm(log_Remittances_fromRus ~  
                    Month +  time_trend + 
                    Ramadan_starts + Eid_al_Fitr + Eid_al_Adha + covid + war + post_war - 1,  
                    data = fulldata_with_lags)

# Perform stepwise regression based on BIC
stepwise_model <- step(initial_model, direction = "both", k = log(nrow(fulldata_with_lags)))

# Compute HC3 robust standard errors for the stepwise model
robust_se_stepwise <- sqrt(diag(vcovHC(stepwise_model, type = "HC3")))

# Print the regression results with HC3 robust standard errors
output_stepwise <- coeftest(stepwise_model, vcov = vcovHC(stepwise_model, type = "HC3"))
print(output_stepwise)

write.csv(output_stepwise, "/Users/michelle/Documents/thesis/remittance regressions/output_stepwise_1.csv", row.names = TRUE)
```



# Reg 2

```{r}
# Load necessary libraries
library(sandwich)
library(lmtest)

initial_model <- lm(log_Remittances_fromRus ~  
                    Month +  time_trend + 
                    Ramadan_starts + Eid_al_Fitr + Eid_al_Adha + covid +  
                    crocus + post_crocus + war + post_war - 1,  
                    data = fulldata_with_lags)

# Perform stepwise regression based on BIC
stepwise_model <- step(initial_model, direction = "both", k = log(nrow(fulldata_with_lags)))

# Compute HC3 robust standard errors for the stepwise model
robust_se_stepwise <- sqrt(diag(vcovHC(stepwise_model, type = "HC3")))

# Print the regression results with HC3 robust standard errors
output_stepwise <- coeftest(stepwise_model, vcov = vcovHC(stepwise_model, type = "HC3"))
print(output_stepwise)

write.csv(output_stepwise, "/Users/michelle/Documents/thesis/remittance regressions/output_stepwise_2.csv", row.names = TRUE)
```




# Reg 3

```{r}
# Load necessary libraries
library(sandwich)
library(lmtest)

initial_model <- lm(log_Remittances_fromRus ~  
                    Month +  time_trend + 
                    Ramadan_starts + Eid_al_Fitr + Eid_al_Adha + covid +  
                    crocus + post_crocus + war + post_war + 
                    log_mediazona + log_mediazona_lag1 + log_mediazona_lag2 + log_mediazona_lag3 + log_mediazona_lag4 + log_mediazona_lag5 + log_mediazona_lag6 + log_mediazona_lag7 + log_mediazona_lag8 - 1,  
                    data = fulldata_with_lags)

# Perform stepwise regression based on BIC
stepwise_model <- step(initial_model, direction = "both", k = log(nrow(fulldata_with_lags)))

# Compute HC3 robust standard errors for the stepwise model
robust_se_stepwise <- sqrt(diag(vcovHC(stepwise_model, type = "HC3")))

# Print the regression results with HC3 robust standard errors
output_stepwise <- coeftest(stepwise_model, vcov = vcovHC(stepwise_model, type = "HC3"))
print(output_stepwise)

write.csv(output_stepwise, "/Users/michelle/Documents/thesis/remittance regressions/output_stepwise_3.csv", row.names = TRUE)

```









# Reg 1 — control for CPI 

```{r}
# Load necessary libraries
library(sandwich)
library(lmtest)

initial_model <- lm(log_Remittances_fromRus ~  
                    Month + time_trend +  `log_Consumer_Price_Index_(CPI)_RUS` + `log_Consumer_Price_Index_(CPI)_KGZ` +
                    Ramadan_starts + Eid_al_Fitr + Eid_al_Adha + covid + war + post_war - 1,  
                    data = fulldata_with_lags)

# Perform stepwise regression based on BIC
stepwise_model <- step(initial_model, direction = "both", k = log(nrow(fulldata_with_lags)))

# Compute HC3 robust standard errors for the stepwise model
robust_se_stepwise <- sqrt(diag(vcovHC(stepwise_model, type = "HC3")))

# Print the regression results with HC3 robust standard errors
output_stepwise <- coeftest(stepwise_model, vcov = vcovHC(stepwise_model, type = "HC3"))
print(output_stepwise)

write.csv(output_stepwise, "/Users/michelle/Documents/thesis/remittance regressions/output_stepwise_1REAL.csv", row.names = TRUE)
```



# Reg 2

```{r}
# Load necessary libraries
library(sandwich)
library(lmtest)

initial_model <- lm(log_Remittances_fromRus ~  
                    Month  + time_trend + `log_Consumer_Price_Index_(CPI)_RUS` + `log_Consumer_Price_Index_(CPI)_KGZ` +
                    Ramadan_starts + Eid_al_Fitr + Eid_al_Adha + covid +  
                    crocus + post_crocus + war + post_war - 1,  
                    data = fulldata_with_lags)

# Perform stepwise regression based on BIC
stepwise_model <- step(initial_model, direction = "both", k = log(nrow(fulldata_with_lags)))

# Compute HC3 robust standard errors for the stepwise model
robust_se_stepwise <- sqrt(diag(vcovHC(stepwise_model, type = "HC3")))

# Print the regression results with HC3 robust standard errors
output_stepwise <- coeftest(stepwise_model, vcov = vcovHC(stepwise_model, type = "HC3"))
print(output_stepwise)

write.csv(output_stepwise, "/Users/michelle/Documents/thesis/remittance regressions/output_stepwise_2REAL.csv", row.names = TRUE)
```




# Reg 3

```{r}
# Load necessary libraries
library(sandwich)
library(lmtest)

initial_model <- lm(log_Remittances_fromRus ~  
                    Month  + time_trend + `log_Consumer_Price_Index_(CPI)_RUS` + `log_Consumer_Price_Index_(CPI)_KGZ` +
                    Ramadan_starts + Eid_al_Fitr + Eid_al_Adha + covid +  
                    crocus + post_crocus + war + post_war + 
                    log_mediazona + log_mediazona_lag1 + log_mediazona_lag2 + log_mediazona_lag3 + log_mediazona_lag4 + log_mediazona_lag5 + log_mediazona_lag6 + log_mediazona_lag7 + log_mediazona_lag8 - 1,  
                    data = fulldata_with_lags)

# Perform stepwise regression based on BIC
stepwise_model <- step(initial_model, direction = "both", k = log(nrow(fulldata_with_lags)))

# Compute HC3 robust standard errors for the stepwise model
robust_se_stepwise <- sqrt(diag(vcovHC(stepwise_model, type = "HC3")))

# Print the regression results with HC3 robust standard errors
output_stepwise <- coeftest(stepwise_model, vcov = vcovHC(stepwise_model, type = "HC3"))
print(output_stepwise)

write.csv(output_stepwise, "/Users/michelle/Documents/thesis/remittance regressions/output_stepwise_3REAL.csv", row.names = TRUE)
```






# Reg 1 - exchange rate

```{r}
# Load necessary libraries
library(sandwich)
library(lmtest)

initial_model <- lm(log_Remittances_fromRus ~  
                    Month +  time_trend + log_KGZ_BRE_RUBLE  +
                    Ramadan_starts + Eid_al_Fitr + Eid_al_Adha + covid + war + post_war - 1,  
                    data = fulldata_with_lags)

# Perform stepwise regression based on BIC
stepwise_model <- step(initial_model, direction = "both", k = log(nrow(fulldata_with_lags)))

# Compute HC3 robust standard errors for the stepwise model
robust_se_stepwise <- sqrt(diag(vcovHC(stepwise_model, type = "HC3")))

# Print the regression results with HC3 robust standard errors
output_stepwise <- coeftest(stepwise_model, vcov = vcovHC(stepwise_model, type = "HC3"))
print(output_stepwise)

write.csv(output_stepwise, "/Users/michelle/Documents/thesis/remittance regressions/output_stepwise_1_EXR.csv", row.names = TRUE)
```



# Reg 2

```{r}
# Load necessary libraries
library(sandwich)
library(lmtest)

initial_model <- lm(log_Remittances_fromRus ~  
                    Month +  time_trend + log_KGZ_BRE_RUBLE +
                    Ramadan_starts + Eid_al_Fitr + Eid_al_Adha + covid +  
                    crocus + post_crocus + war + post_war - 1,  
                    data = fulldata_with_lags)

# Perform stepwise regression based on BIC
stepwise_model <- step(initial_model, direction = "both", k = log(nrow(fulldata_with_lags)))

# Compute HC3 robust standard errors for the stepwise model
robust_se_stepwise <- sqrt(diag(vcovHC(stepwise_model, type = "HC3")))

# Print the regression results with HC3 robust standard errors
output_stepwise <- coeftest(stepwise_model, vcov = vcovHC(stepwise_model, type = "HC3"))
print(output_stepwise)

write.csv(output_stepwise, "/Users/michelle/Documents/thesis/remittance regressions/output_stepwise_2_EXR.csv", row.names = TRUE)
```




# Reg 3

```{r}
# Load necessary libraries
library(sandwich)
library(lmtest)

initial_model <- lm(log_Remittances_fromRus ~  
                    Month +  time_trend + log_KGZ_BRE_RUBLE + 
                    Ramadan_starts + Eid_al_Fitr + Eid_al_Adha + covid +  
                    crocus + post_crocus + war + post_war + 
                    log_mediazona + log_mediazona_lag1 + log_mediazona_lag2 + log_mediazona_lag3 + log_mediazona_lag4 + log_mediazona_lag5 + log_mediazona_lag6 + log_mediazona_lag7 + log_mediazona_lag8 - 1,  
                    data = fulldata_with_lags)

# Perform stepwise regression based on BIC
stepwise_model <- step(initial_model, direction = "both", k = log(nrow(fulldata_with_lags)))

# Compute HC3 robust standard errors for the stepwise model
robust_se_stepwise <- sqrt(diag(vcovHC(stepwise_model, type = "HC3")))

# Print the regression results with HC3 robust standard errors
output_stepwise <- coeftest(stepwise_model, vcov = vcovHC(stepwise_model, type = "HC3"))
print(output_stepwise)

write.csv(output_stepwise, "/Users/michelle/Documents/thesis/remittance regressions/output_stepwise_3_EXR.csv", row.names = TRUE)

```









# Reg 1 — control for CPI + exchange rate

```{r}
# Load necessary libraries
library(sandwich)
library(lmtest)

initial_model <- lm(log_Remittances_fromRus ~  
                    Month + time_trend + log_KGZ_BRE_RUBLE +  `log_Consumer_Price_Index_(CPI)_RUS` + `log_Consumer_Price_Index_(CPI)_KGZ` +
                    Ramadan_starts + Eid_al_Fitr + Eid_al_Adha + covid + war + post_war - 1,  
                    data = fulldata_with_lags)

# Perform stepwise regression based on BIC
stepwise_model <- step(initial_model, direction = "both", k = log(nrow(fulldata_with_lags)))

# Compute HC3 robust standard errors for the stepwise model
robust_se_stepwise <- sqrt(diag(vcovHC(stepwise_model, type = "HC3")))

# Print the regression results with HC3 robust standard errors
output_stepwise <- coeftest(stepwise_model, vcov = vcovHC(stepwise_model, type = "HC3"))
print(output_stepwise)

write.csv(output_stepwise, "/Users/michelle/Documents/thesis/remittance regressions/output_stepwise_1REAL_EXR.csv", row.names = TRUE)
```



# Reg 2

```{r}
# Load necessary libraries
library(sandwich)
library(lmtest)

initial_model <- lm(log_Remittances_fromRus ~  
                    Month  + time_trend + log_KGZ_BRE_RUBLE +  `log_Consumer_Price_Index_(CPI)_RUS` + `log_Consumer_Price_Index_(CPI)_KGZ` +
                    Ramadan_starts + Eid_al_Fitr + Eid_al_Adha + covid +  
                    crocus + post_crocus + war + post_war - 1,  
                    data = fulldata_with_lags)

# Perform stepwise regression based on BIC
stepwise_model <- step(initial_model, direction = "both", k = log(nrow(fulldata_with_lags)))

# Compute HC3 robust standard errors for the stepwise model
robust_se_stepwise <- sqrt(diag(vcovHC(stepwise_model, type = "HC3")))

# Print the regression results with HC3 robust standard errors
output_stepwise <- coeftest(stepwise_model, vcov = vcovHC(stepwise_model, type = "HC3"))
print(output_stepwise)

write.csv(output_stepwise, "/Users/michelle/Documents/thesis/remittance regressions/output_stepwise_2REAL_EXR.csv", row.names = TRUE)
```




# Reg 3

```{r}
# Load necessary libraries
library(sandwich)
library(lmtest)

initial_model <- lm(log_Remittances_fromRus ~  
                    Month  + time_trend + log_KGZ_BRE_RUBLE + `log_Consumer_Price_Index_(CPI)_RUS` + `log_Consumer_Price_Index_(CPI)_KGZ` +
                    Ramadan_starts + Eid_al_Fitr + Eid_al_Adha + covid +  
                    crocus + post_crocus + war + post_war + 
                    log_mediazona + log_mediazona_lag1 + log_mediazona_lag2 + log_mediazona_lag3 + log_mediazona_lag4 + log_mediazona_lag5 + log_mediazona_lag6 + log_mediazona_lag7 + log_mediazona_lag8 - 1,  
                    data = fulldata_with_lags)

# Perform stepwise regression based on BIC
stepwise_model <- step(initial_model, direction = "both", k = log(nrow(fulldata_with_lags)))

# Compute HC3 robust standard errors for the stepwise model
robust_se_stepwise <- sqrt(diag(vcovHC(stepwise_model, type = "HC3")))

# Print the regression results with HC3 robust standard errors
output_stepwise <- coeftest(stepwise_model, vcov = vcovHC(stepwise_model, type = "HC3"))
print(output_stepwise)

write.csv(output_stepwise, "/Users/michelle/Documents/thesis/remittance regressions/output_stepwise_3REAL_EXR.csv", row.names = TRUE)
```




#Add in wage data 


## Adding in economic covariates: narrow it down first

Remove covariates that lack observations for the critical timeframe. 121 vars.
```{r}
fulldata <- fulldata_copy

tempset <- fulldata %>%
  filter(Month <= as.Date("2024-09-01") & Month >= as.Date("2016-01-01"))

na_columns <- colnames(tempset)[colSums(is.na(tempset)) > 0]
fulldata <- fulldata %>% dplyr::select(-all_of(na_columns))
na_columns
```

Find percentage variables
```{r}
fulldata <- fulldata %>%
  dplyr::select(-predicted)

# Find columns that fluctuate between 50 and 150 or have "_pct_" in their name
percentage_columns <- fulldata %>%
  select_if(is.numeric) %>%
  summarise_all(~ all(. >= 70 & . <= 150, na.rm = TRUE)) %>%
  gather() %>%
  filter(value == TRUE) %>%
  pull(key) #these are all exchange rates, which we DO want to log. 

# Add columns that have "_pct_" in their name
pct_columns_by_percent <- grep("percent", colnames(fulldata), value = TRUE)
pct_columns_by_rate <- grep("rate", colnames(fulldata), value = TRUE)
pct_columns_by_ratio <- grep("ratio", colnames(fulldata), value = TRUE)
pct_columns_by_changeinindu <- grep("changeinindu", colnames(fulldata), value = TRUE)

# Combine both sets of percentage columns
all_percentage_columns <- unique(c(pct_columns_by_percent, pct_columns_by_rate, pct_columns_by_ratio, pct_columns_by_changeinindu)) 

shouldbelogged <- c("Foreign_exchange_reserves_billion_currency_units_KGZ", "USD_Exchange_rate_KGZ", "Foreign_exchange_reserves_billion_currency_units_RUS", "USD_Exchange_rate_RUS")

all_percentage_columns <- setdiff(all_percentage_columns, shouldbelogged)

# Print the list of columns designated as percentages
print(all_percentage_columns)

# Get the columns that are not percentage columns
non_percentage_columns <- setdiff(colnames(fulldata), all_percentage_columns)

# Filter out the rows where values in these columns exceed 1
levels_variables <- fulldata %>% 
  dplyr::select(non_percentage_columns) %>% 
  summarise_all(~ sum(. > 1, na.rm = TRUE)) %>%
  gather(variable, count) %>%
  filter(count > 0)

print(levels_variables, n=1000)

# Define the variables to exclude
exclude_variables <- c(
  "post_war", "post_crocus", "time_trend", "Month", 
  "commbanks_loans_to_deposits_foreign_currency_KGZ", 
  "commbanks_loan_loss_provision_KGZ", "Ramadan_starts", 
  "Eid_al_Fitr", "Eid_al_Adha", "war", "crocus", "covid", 
  "jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", 
  "sep", "oct", "nov", "dec"
)

# Remove the specified variables from the levels_variables list
levels_variables_filtered <- setdiff(levels_variables$variable, exclude_variables)

# Print the remaining "levels" variables
print(levels_variables_filtered)

library(dplyr)

# Loop through each variable in levels_variables_filtered and check for values < 0
levels_variables_filtered <- levels_variables_filtered[sapply(levels_variables_filtered, function(var) {
  # Check if there are any values less than 0 in the column
  all(fulldata[[var]] >= 0, na.rm = TRUE)  # Return TRUE if all values are >= 0
})]

# Apply log transformation and rename variables
fulldata <- fulldata %>%
  mutate(across(all_of(levels_variables_filtered), 
                ~ log1p(.), 
                .names = "log_{.col}"))

fulldata <- fulldata %>%
  dplyr::select(-all_of(levels_variables_filtered))  # Remove original variables

# Print the updated dataframe column names to verify the transformation
print(colnames(fulldata))
```


BIG QUESTION: WHAT DO I WANT TO TEST?
- General trends: with month dummies / linear trend controlled for, does war have an effect?
- General trends: with month dummies / linear trend / war controlled for, does crocus have an effect?
- General trends: with month dummies / linear trend / war / crocus controlled for, does mediazona have an effect?
- With all econ covariates that won't interfere with the causal pipeline, add them that will clear out any effect associated with them.
--- don't use exchange rates, employment because they're all related to war... all covariates somehow affect war. let's just see how these work. 
--- USE inflation for KGZ and RUS to get a sense of real remittance values. level and change?
- log_Consumer_Price_Index_(CPI)_KGZ
- log_Consumer_Price_Index_(CPI)_RUS
- Inflation_monthly_percent_change_in_the_CPI_KGZ & Inflation_monthly_percent_change_in_the_CPI_RUS not needed because we only really care about controlling for price level, and this would be a mediator effect from war.

```{r}
fulldata <- fulldata %>%
  dplyr::select(Month, Ramadan_starts, Eid_al_Fitr, Eid_al_Adha, war, post_war, crocus, post_crocus, covid, time_trend, log_Remittances_fromRus, log_mediazona, `log_Consumer_Price_Index_(CPI)_KGZ`, `log_Consumer_Price_Index_(CPI)_RUS`, log_avg_nominal_gross_wages_RUSall, log_avg_nominal_gross_wages_RUSmoscowoblast, log_avg_nominal_gross_wages_RUSmoscowcity, log_avg_nominal_gross_wages_RUSpetersburgscity, log_avg_nominal_gross_wages_RUSnizhninovoblast, log_avg_nominal_gross_wages_RUSchelyabinskoblast, log_avg_nominal_gross_wages_RUSsakha, log_avg_nominal_gross_wages_RUSsakhalin, log_avg_nominal_gross_wages_RUSkrasnoyarsk, log_avg_nominal_gross_wages_RUStyumenoblast, log_KGZ_BRE_RUBLE, log_KGZ_REER_EAEU)
```

Lags
```{r}
excluded_vars <- c("log_Remittances_fromRus", "Ramadan_starts", 
                   "Eid_al_Fitr", "Eid_al_Adha", "war", "post_war", "crocus", 
                   "post_crocus", "covid", "Month", "time_trend")

# Get a list of all the variable names in `fulldata`
all_vars <- colnames(fulldata)

# Filter out the variables that we don't want to lag
vars_to_lag <- setdiff(all_vars, excluded_vars)

# Create the lags for the variables in `vars_to_lag` using dplyr
library(dplyr)

fulldata_with_lags <- fulldata %>%
  arrange(Month) %>%
  mutate(across(all_of(vars_to_lag), list(lag1 = ~ lag(., 1)), .names = "{.col}_lag1"))

# Display the first few rows to verify
head(fulldata_with_lags)
```

Limit dates
```{r}
# Prep for industrialproduction-focused regression
fulldata_with_lags <- fulldata_with_lags %>% 
  filter(Month <= as.Date("2024-09-01")) %>%
  filter(Month >= as.Date("2016-01-01")) %>%
  dplyr::select(where(~ !any(is.na(.))))

#Factorize months
fulldata_with_lags$Month <- factor(format(fulldata_with_lags$Month, "%m"))
fulldata_with_lags <- fulldata_with_lags %>%
  mutate(Month = as.factor(Month))
  
#fulldata_with_lags <- fulldata_with_lags[, !(colnames(fulldata_with_lags) == "Month")]

fulldata_with_lags <- fulldata_with_lags %>%
  dplyr::select(-time_trend)


fulldata_with_lags$log_mediazona_lag2 <- lag(fulldata_with_lags$log_mediazona, 2)
fulldata_with_lags$log_mediazona_lag3 <- lag(fulldata_with_lags$log_mediazona, 3)
fulldata_with_lags$log_mediazona_lag4 <- lag(fulldata_with_lags$log_mediazona, 4)
fulldata_with_lags$log_mediazona_lag5 <- lag(fulldata_with_lags$log_mediazona, 5)
fulldata_with_lags$log_mediazona_lag6 <- lag(fulldata_with_lags$log_mediazona, 6)
fulldata_with_lags$log_mediazona_lag7 <- lag(fulldata_with_lags$log_mediazona, 7)
fulldata_with_lags$log_mediazona_lag8 <- lag(fulldata_with_lags$log_mediazona, 8)

# Impute 0s for all NAs (it's just mediazona, which would be 0 because the war hadn't started yet)
fulldata_with_lags[is.na(fulldata_with_lags)] <- 0
```

Add correct time trend
```{r}
fulldata_with_lags <- fulldata_with_lags %>%
  mutate(time_trend = row_number())
```




# Reg 1

```{r}
# Load necessary libraries
library(sandwich)
library(lmtest)

initial_model <- lm(log_Remittances_fromRus ~  
                    Month +  time_trend + log_avg_nominal_gross_wages_RUSmoscowoblast +
                      log_avg_nominal_gross_wages_RUSsakha + log_avg_nominal_gross_wages_RUSsakhalin + 
                      log_avg_nominal_gross_wages_RUSall + 
                    Ramadan_starts + Eid_al_Fitr + Eid_al_Adha + covid + war + post_war - 1,  
                    data = fulldata_with_lags)

# Perform stepwise regression based on BIC
stepwise_model <- step(initial_model, direction = "both", k = log(nrow(fulldata_with_lags)))

# Compute HC3 robust standard errors for the stepwise model
robust_se_stepwise <- sqrt(diag(vcovHC(stepwise_model, type = "HC3")))

# Print the regression results with HC3 robust standard errors
output_stepwise <- coeftest(stepwise_model, vcov = vcovHC(stepwise_model, type = "HC3"))
print(output_stepwise)

write.csv(output_stepwise, "/Users/michelle/Documents/thesis/remittance regressions/output_stepwise_1_WAGECONTROL.csv", row.names = TRUE)
```



# Reg 2

```{r}
# Load necessary libraries
library(sandwich)
library(lmtest)

initial_model <- lm(log_Remittances_fromRus ~  
                    Month +  time_trend + log_avg_nominal_gross_wages_RUSmoscowoblast +
                      log_avg_nominal_gross_wages_RUSsakha + log_avg_nominal_gross_wages_RUSsakhalin + 
                      log_avg_nominal_gross_wages_RUSall + 
                    Ramadan_starts + Eid_al_Fitr + Eid_al_Adha + covid +  
                    crocus + post_crocus + war + post_war - 1,  
                    data = fulldata_with_lags)

# Perform stepwise regression based on BIC
stepwise_model <- step(initial_model, direction = "both", k = log(nrow(fulldata_with_lags)))

# Compute HC3 robust standard errors for the stepwise model
robust_se_stepwise <- sqrt(diag(vcovHC(stepwise_model, type = "HC3")))

# Print the regression results with HC3 robust standard errors
output_stepwise <- coeftest(stepwise_model, vcov = vcovHC(stepwise_model, type = "HC3"))
print(output_stepwise)

write.csv(output_stepwise, "/Users/michelle/Documents/thesis/remittance regressions/output_stepwise_2_WAGECONTROL.csv", row.names = TRUE)
```




# Reg 3

```{r}
# Load necessary libraries
library(sandwich)
library(lmtest)

initial_model <- lm(log_Remittances_fromRus ~  
                    Month +  time_trend + log_avg_nominal_gross_wages_RUSmoscowoblast +
                      log_avg_nominal_gross_wages_RUSsakha + log_avg_nominal_gross_wages_RUSsakhalin + 
                      log_avg_nominal_gross_wages_RUSall + 
                    Ramadan_starts + Eid_al_Fitr + Eid_al_Adha + covid +  
                    crocus + post_crocus + war + post_war + 
                    log_mediazona  + log_mediazona_lag2  + log_mediazona_lag4  + log_mediazona_lag6 + log_mediazona_lag8 - 1,  
                    data = fulldata_with_lags)

# Perform stepwise regression based on BIC
stepwise_model <- step(initial_model, direction = "both", k = log(nrow(fulldata_with_lags)))

# Compute HC3 robust standard errors for the stepwise model
robust_se_stepwise <- sqrt(diag(vcovHC(stepwise_model, type = "HC3")))

# Print the regression results with HC3 robust standard errors
output_stepwise <- coeftest(stepwise_model, vcov = vcovHC(stepwise_model, type = "HC3"))
print(output_stepwise)

write.csv(output_stepwise, "/Users/michelle/Documents/thesis/remittance regressions/output_stepwise_3_WAGECONTROL.csv", row.names = TRUE)

```









# Reg 1 — control for CPI 

```{r}
# Load necessary libraries
library(sandwich)
library(lmtest)

initial_model <- lm(log_Remittances_fromRus ~  
                    Month + time_trend +  `log_Consumer_Price_Index_(CPI)_RUS` + `log_Consumer_Price_Index_(CPI)_KGZ` + log_avg_nominal_gross_wages_RUSmoscowoblast +
                      log_avg_nominal_gross_wages_RUSsakha + log_avg_nominal_gross_wages_RUSsakhalin + 
                      log_avg_nominal_gross_wages_RUSall + 
                    Ramadan_starts + Eid_al_Fitr + Eid_al_Adha + covid + war + post_war - 1,  
                    data = fulldata_with_lags)

# Perform stepwise regression based on BIC
stepwise_model <- step(initial_model, direction = "both", k = log(nrow(fulldata_with_lags)))

# Compute HC3 robust standard errors for the stepwise model
robust_se_stepwise <- sqrt(diag(vcovHC(stepwise_model, type = "HC3")))

# Print the regression results with HC3 robust standard errors
output_stepwise <- coeftest(stepwise_model, vcov = vcovHC(stepwise_model, type = "HC3"))
print(output_stepwise)

write.csv(output_stepwise, "/Users/michelle/Documents/thesis/remittance regressions/output_stepwise_1REAL_WAGECONTROL.csv", row.names = TRUE)
```



# Reg 2

```{r}
# Load necessary libraries
library(sandwich)
library(lmtest)

initial_model <- lm(log_Remittances_fromRus ~  
                    Month  + time_trend + `log_Consumer_Price_Index_(CPI)_RUS` + `log_Consumer_Price_Index_(CPI)_KGZ` + log_avg_nominal_gross_wages_RUSmoscowoblast +
                      log_avg_nominal_gross_wages_RUSsakha + log_avg_nominal_gross_wages_RUSsakhalin + 
                      log_avg_nominal_gross_wages_RUSall + 
                    Ramadan_starts + Eid_al_Fitr + Eid_al_Adha + covid +  
                    crocus + post_crocus + war + post_war - 1,  
                    data = fulldata_with_lags)

# Perform stepwise regression based on BIC
stepwise_model <- step(initial_model, direction = "both", k = log(nrow(fulldata_with_lags)))

# Compute HC3 robust standard errors for the stepwise model
robust_se_stepwise <- sqrt(diag(vcovHC(stepwise_model, type = "HC3")))

# Print the regression results with HC3 robust standard errors
output_stepwise <- coeftest(stepwise_model, vcov = vcovHC(stepwise_model, type = "HC3"))
print(output_stepwise)

write.csv(output_stepwise, "/Users/michelle/Documents/thesis/remittance regressions/output_stepwise_2REAL_WAGECONTROL.csv", row.names = TRUE)
```




# Reg 3

```{r}
# Load necessary libraries
library(sandwich)
library(lmtest)

initial_model <- lm(log_Remittances_fromRus ~  
                    Month  + time_trend + `log_Consumer_Price_Index_(CPI)_RUS` + `log_Consumer_Price_Index_(CPI)_KGZ` + log_avg_nominal_gross_wages_RUSmoscowoblast +
                      log_avg_nominal_gross_wages_RUSsakha + log_avg_nominal_gross_wages_RUSsakhalin + 
                      log_avg_nominal_gross_wages_RUSall + 
                    Ramadan_starts + Eid_al_Fitr + Eid_al_Adha + covid +  
                    crocus + post_crocus + war + post_war + 
                    log_mediazona + log_mediazona_lag2 + log_mediazona_lag4 + log_mediazona_lag6 + log_mediazona_lag8 - 1,  
                    data = fulldata_with_lags)

# Perform stepwise regression based on BIC
stepwise_model <- step(initial_model, direction = "both", k = log(nrow(fulldata_with_lags)))

# Compute HC3 robust standard errors for the stepwise model
robust_se_stepwise <- sqrt(diag(vcovHC(stepwise_model, type = "HC3")))

# Print the regression results with HC3 robust standard errors
output_stepwise <- coeftest(stepwise_model, vcov = vcovHC(stepwise_model, type = "HC3"))
print(output_stepwise)

write.csv(output_stepwise, "/Users/michelle/Documents/thesis/remittance regressions/output_stepwise_3REAL_WAGECONTROL.csv", row.names = TRUE)
```








# Reg 1 — control for CPI

```{r}
# Load necessary libraries
library(sandwich)
library(lmtest)

initial_model <- lm(log_Remittances_fromRus ~  
                    Month + time_trend +  `log_Consumer_Price_Index_(CPI)_RUS` + `log_Consumer_Price_Index_(CPI)_KGZ` +
                      log_avg_nominal_gross_wages_RUSmoscowoblast +
                      log_avg_nominal_gross_wages_RUSsakha + log_avg_nominal_gross_wages_RUSsakhalin + 
                      log_avg_nominal_gross_wages_RUSall + 
                    Ramadan_starts + Eid_al_Fitr + Eid_al_Adha + covid + war + post_war - 1,  
                    data = fulldata_with_lags)

# Perform stepwise regression based on BIC
stepwise_model <- step(initial_model, direction = "both", k = log(nrow(fulldata_with_lags)))

# Compute HC3 robust standard errors for the stepwise model
robust_se_stepwise <- sqrt(diag(vcovHC(stepwise_model, type = "HC3")))

# Print the regression results with HC3 robust standard errors
output_stepwise <- coeftest(stepwise_model, vcov = vcovHC(stepwise_model, type = "HC3"))
print(output_stepwise)

write.csv(output_stepwise, "/Users/michelle/Documents/thesis/remittance regressions/output_stepwise_1REAL_WAGECONTROL.csv", row.names = TRUE)
```



# Reg 2

```{r}
# Load necessary libraries
library(sandwich)
library(lmtest)

initial_model <- lm(log_Remittances_fromRus ~  
                    Month  + time_trend + `log_Consumer_Price_Index_(CPI)_RUS` + `log_Consumer_Price_Index_(CPI)_KGZ` + log_avg_nominal_gross_wages_RUSmoscowoblast +
                      log_avg_nominal_gross_wages_RUSsakha + log_avg_nominal_gross_wages_RUSsakhalin + 
                      log_avg_nominal_gross_wages_RUSall + 
                    Ramadan_starts + Eid_al_Fitr + Eid_al_Adha + covid +  
                    crocus + post_crocus + war + post_war - 1,  
                    data = fulldata_with_lags)

# Perform stepwise regression based on BIC
stepwise_model <- step(initial_model, direction = "both", k = log(nrow(fulldata_with_lags)))

# Compute HC3 robust standard errors for the stepwise model
robust_se_stepwise <- sqrt(diag(vcovHC(stepwise_model, type = "HC3")))

# Print the regression results with HC3 robust standard errors
output_stepwise <- coeftest(stepwise_model, vcov = vcovHC(stepwise_model, type = "HC3"))
print(output_stepwise)

write.csv(output_stepwise, "/Users/michelle/Documents/thesis/remittance regressions/output_stepwise_2REAL_WAGECONTROL.csv", row.names = TRUE)
```




# Reg 3

```{r}
# Load necessary libraries
library(sandwich)
library(lmtest)

initial_model <- lm(log_Remittances_fromRus ~  
                    Month  + time_trend + `log_Consumer_Price_Index_(CPI)_RUS` + `log_Consumer_Price_Index_(CPI)_KGZ` + log_avg_nominal_gross_wages_RUSmoscowoblast +
                      log_avg_nominal_gross_wages_RUSsakha + log_avg_nominal_gross_wages_RUSsakhalin + 
                      log_avg_nominal_gross_wages_RUSall + 
                    Ramadan_starts + Eid_al_Fitr + Eid_al_Adha + covid +  
                    crocus + post_crocus + war + post_war + 
                    log_mediazona + log_mediazona_lag2 + log_mediazona_lag4 + log_mediazona_lag6 + log_mediazona_lag8 - 1,  
                    data = fulldata_with_lags)

# Perform stepwise regression based on BIC
stepwise_model <- step(initial_model, direction = "both", k = log(nrow(fulldata_with_lags)))

# Compute HC3 robust standard errors for the stepwise model
robust_se_stepwise <- sqrt(diag(vcovHC(stepwise_model, type = "HC3")))

# Print the regression results with HC3 robust standard errors
output_stepwise <- coeftest(stepwise_model, vcov = vcovHC(stepwise_model, type = "HC3"))
print(output_stepwise)

write.csv(output_stepwise, "/Users/michelle/Documents/thesis/remittance regressions/output_stepwise_3REAL_WAGECONTROL.csv", row.names = TRUE)
```








# Reg 1

```{r}
# Load necessary libraries
library(sandwich)
library(lmtest)

initial_model <- lm(log_Remittances_fromRus ~  
                    Month +  time_trend + log_avg_nominal_gross_wages_RUSmoscowoblast +
                      log_avg_nominal_gross_wages_RUSsakha + log_avg_nominal_gross_wages_RUSsakhalin + 
                      log_avg_nominal_gross_wages_RUSall + 
                    Ramadan_starts + Eid_al_Fitr + Eid_al_Adha + covid + war + post_war - 1,  
                    data = fulldata_with_lags)

# Perform stepwise regression based on BIC
stepwise_model <- step(initial_model, direction = "both", k = log(nrow(fulldata_with_lags)))

# Compute HC3 robust standard errors for the stepwise model
robust_se_stepwise <- sqrt(diag(vcovHC(stepwise_model, type = "HC3")))

# Print the regression results with HC3 robust standard errors
output_stepwise <- coeftest(stepwise_model, vcov = vcovHC(stepwise_model, type = "HC3"))
print(output_stepwise)

write.csv(output_stepwise, "/Users/michelle/Documents/thesis/remittance regressions/output_stepwise_1_WAGECONTROL.csv", row.names = TRUE)
```



# Reg 2

```{r}
# Load necessary libraries
library(sandwich)
library(lmtest)

initial_model <- lm(log_Remittances_fromRus ~  
                    Month +  time_trend + log_avg_nominal_gross_wages_RUSmoscowoblast +
                      log_avg_nominal_gross_wages_RUSsakha + log_avg_nominal_gross_wages_RUSsakhalin + 
                      log_avg_nominal_gross_wages_RUSall + 
                    Ramadan_starts + Eid_al_Fitr + Eid_al_Adha + covid +  
                    crocus + post_crocus + war + post_war - 1,  
                    data = fulldata_with_lags)

# Perform stepwise regression based on BIC
stepwise_model <- step(initial_model, direction = "both", k = log(nrow(fulldata_with_lags)))

# Compute HC3 robust standard errors for the stepwise model
robust_se_stepwise <- sqrt(diag(vcovHC(stepwise_model, type = "HC3")))

# Print the regression results with HC3 robust standard errors
output_stepwise <- coeftest(stepwise_model, vcov = vcovHC(stepwise_model, type = "HC3"))
print(output_stepwise)

write.csv(output_stepwise, "/Users/michelle/Documents/thesis/remittance regressions/output_stepwise_2_WAGECONTROL.csv", row.names = TRUE)
```




# Reg 3

```{r}
# Load necessary libraries
library(sandwich)
library(lmtest)

initial_model <- lm(log_Remittances_fromRus ~  
                    Month +  time_trend + log_avg_nominal_gross_wages_RUSmoscowoblast +
                      log_avg_nominal_gross_wages_RUSsakha + log_avg_nominal_gross_wages_RUSsakhalin + 
                      log_avg_nominal_gross_wages_RUSall + 
                    Ramadan_starts + Eid_al_Fitr + Eid_al_Adha + covid +  
                    crocus + post_crocus + war + post_war + 
                    log_mediazona  + log_mediazona_lag2  + log_mediazona_lag4  + log_mediazona_lag6 + log_mediazona_lag8 - 1,  
                    data = fulldata_with_lags)

# Perform stepwise regression based on BIC
stepwise_model <- step(initial_model, direction = "both", k = log(nrow(fulldata_with_lags)))

# Compute HC3 robust standard errors for the stepwise model
robust_se_stepwise <- sqrt(diag(vcovHC(stepwise_model, type = "HC3")))

# Print the regression results with HC3 robust standard errors
output_stepwise <- coeftest(stepwise_model, vcov = vcovHC(stepwise_model, type = "HC3"))
print(output_stepwise)

write.csv(output_stepwise, "/Users/michelle/Documents/thesis/remittance regressions/output_stepwise_3_WAGECONTROL.csv", row.names = TRUE)

```













# Reg 1 — control for CPI

```{r}
# Load necessary libraries
library(sandwich)
library(lmtest)

initial_model <- lm(log_Remittances_fromRus ~  
                    Month + time_trend +  `log_Consumer_Price_Index_(CPI)_RUS` + `log_Consumer_Price_Index_(CPI)_KGZ` +
                      log_avg_nominal_gross_wages_RUSmoscowoblast + log_KGZ_BRE_RUBLE + 
                      log_avg_nominal_gross_wages_RUSsakha + log_avg_nominal_gross_wages_RUSsakhalin + 
                      log_avg_nominal_gross_wages_RUSall + 
                    Ramadan_starts + Eid_al_Fitr + Eid_al_Adha + covid + war + post_war - 1,  
                    data = fulldata_with_lags)

# Perform stepwise regression based on BIC
stepwise_model <- step(initial_model, direction = "both", k = log(nrow(fulldata_with_lags)))

# Compute HC3 robust standard errors for the stepwise model
robust_se_stepwise <- sqrt(diag(vcovHC(stepwise_model, type = "HC3")))

# Print the regression results with HC3 robust standard errors
output_stepwise <- coeftest(stepwise_model, vcov = vcovHC(stepwise_model, type = "HC3"))
print(output_stepwise)

write.csv(output_stepwise, "/Users/michelle/Documents/thesis/remittance regressions/output_stepwise_1REAL_WAGECONTROL_EXR.csv", row.names = TRUE)
```



# Reg 2

```{r}
# Load necessary libraries
library(sandwich)
library(lmtest)

initial_model <- lm(log_Remittances_fromRus ~  
                    Month  + time_trend + `log_Consumer_Price_Index_(CPI)_RUS` + `log_Consumer_Price_Index_(CPI)_KGZ` + log_avg_nominal_gross_wages_RUSmoscowoblast + log_KGZ_BRE_RUBLE + 
                      log_avg_nominal_gross_wages_RUSsakha + log_avg_nominal_gross_wages_RUSsakhalin + 
                      log_avg_nominal_gross_wages_RUSall + 
                    Ramadan_starts + Eid_al_Fitr + Eid_al_Adha + covid +  
                    crocus + post_crocus + war + post_war - 1,  
                    data = fulldata_with_lags)

# Perform stepwise regression based on BIC
stepwise_model <- step(initial_model, direction = "both", k = log(nrow(fulldata_with_lags)))

# Compute HC3 robust standard errors for the stepwise model
robust_se_stepwise <- sqrt(diag(vcovHC(stepwise_model, type = "HC3")))

# Print the regression results with HC3 robust standard errors
output_stepwise <- coeftest(stepwise_model, vcov = vcovHC(stepwise_model, type = "HC3"))
print(output_stepwise)

write.csv(output_stepwise, "/Users/michelle/Documents/thesis/remittance regressions/output_stepwise_2REAL_WAGECONTROL_EXR.csv", row.names = TRUE)
```




# Reg 3

```{r}
# Load necessary libraries
library(sandwich)
library(lmtest)

initial_model <- lm(log_Remittances_fromRus ~  
                    Month  + time_trend + `log_Consumer_Price_Index_(CPI)_RUS` + `log_Consumer_Price_Index_(CPI)_KGZ` + log_avg_nominal_gross_wages_RUSmoscowoblast + log_KGZ_BRE_RUBLE + 
                      log_avg_nominal_gross_wages_RUSsakha + log_avg_nominal_gross_wages_RUSsakhalin + 
                      log_avg_nominal_gross_wages_RUSall + 
                    Ramadan_starts + Eid_al_Fitr + Eid_al_Adha + covid +  
                    crocus + post_crocus + war + post_war + 
                    log_mediazona + log_mediazona_lag2 + log_mediazona_lag4 + log_mediazona_lag6 + log_mediazona_lag8 - 1,  
                    data = fulldata_with_lags)

# Perform stepwise regression based on BIC
stepwise_model <- step(initial_model, direction = "both", k = log(nrow(fulldata_with_lags)))

# Compute HC3 robust standard errors for the stepwise model
robust_se_stepwise <- sqrt(diag(vcovHC(stepwise_model, type = "HC3")))

# Print the regression results with HC3 robust standard errors
output_stepwise <- coeftest(stepwise_model, vcov = vcovHC(stepwise_model, type = "HC3"))
print(output_stepwise)

write.csv(output_stepwise, "/Users/michelle/Documents/thesis/remittance regressions/output_stepwise_3REAL_WAGECONTROL_EXR.csv", row.names = TRUE)
```








# Reg 1

```{r}
# Load necessary libraries
library(sandwich)
library(lmtest)

initial_model <- lm(log_Remittances_fromRus ~  
                    Month +  time_trend + log_avg_nominal_gross_wages_RUSmoscowoblast +
                      log_avg_nominal_gross_wages_RUSsakha + log_avg_nominal_gross_wages_RUSsakhalin + 
                      log_avg_nominal_gross_wages_RUSall + log_KGZ_BRE_RUBLE + 
                    Ramadan_starts + Eid_al_Fitr + Eid_al_Adha + covid + war + post_war - 1,  
                    data = fulldata_with_lags)

# Perform stepwise regression based on BIC
stepwise_model <- step(initial_model, direction = "both", k = log(nrow(fulldata_with_lags)))

# Compute HC3 robust standard errors for the stepwise model
robust_se_stepwise <- sqrt(diag(vcovHC(stepwise_model, type = "HC3")))

# Print the regression results with HC3 robust standard errors
output_stepwise <- coeftest(stepwise_model, vcov = vcovHC(stepwise_model, type = "HC3"))
print(output_stepwise)

write.csv(output_stepwise, "/Users/michelle/Documents/thesis/remittance regressions/output_stepwise_1_WAGECONTROL_EXR.csv", row.names = TRUE)
```



# Reg 2

```{r}
# Load necessary libraries
library(sandwich)
library(lmtest)

initial_model <- lm(log_Remittances_fromRus ~  
                    Month +  time_trend + log_avg_nominal_gross_wages_RUSmoscowoblast +
                      log_avg_nominal_gross_wages_RUSsakha + log_avg_nominal_gross_wages_RUSsakhalin + 
                      log_avg_nominal_gross_wages_RUSall + log_KGZ_BRE_RUBLE +
                    Ramadan_starts + Eid_al_Fitr + Eid_al_Adha + covid +  
                    crocus + post_crocus + war + post_war - 1,  
                    data = fulldata_with_lags)

# Perform stepwise regression based on BIC
stepwise_model <- step(initial_model, direction = "both", k = log(nrow(fulldata_with_lags)))

# Compute HC3 robust standard errors for the stepwise model
robust_se_stepwise <- sqrt(diag(vcovHC(stepwise_model, type = "HC3")))

# Print the regression results with HC3 robust standard errors
output_stepwise <- coeftest(stepwise_model, vcov = vcovHC(stepwise_model, type = "HC3"))
print(output_stepwise)

write.csv(output_stepwise, "/Users/michelle/Documents/thesis/remittance regressions/output_stepwise_2_WAGECONTROL_EX.csv", row.names = TRUE)
```




# Reg 3

```{r}
# Load necessary libraries
library(sandwich)
library(lmtest)

initial_model <- lm(log_Remittances_fromRus ~  
                    Month +  time_trend + log_avg_nominal_gross_wages_RUSmoscowoblast +
                      log_avg_nominal_gross_wages_RUSsakha + log_avg_nominal_gross_wages_RUSsakhalin + 
                      log_avg_nominal_gross_wages_RUSall + log_KGZ_BRE_RUBLE + 
                    Ramadan_starts + Eid_al_Fitr + Eid_al_Adha + covid +  
                    crocus + post_crocus + war + post_war + 
                    log_mediazona  + log_mediazona_lag2  + log_mediazona_lag4  + log_mediazona_lag6 + log_mediazona_lag8 - 1,  
                    data = fulldata_with_lags)

# Perform stepwise regression based on BIC
stepwise_model <- step(initial_model, direction = "both", k = log(nrow(fulldata_with_lags)))

# Compute HC3 robust standard errors for the stepwise model
robust_se_stepwise <- sqrt(diag(vcovHC(stepwise_model, type = "HC3")))

# Print the regression results with HC3 robust standard errors
output_stepwise <- coeftest(stepwise_model, vcov = vcovHC(stepwise_model, type = "HC3"))
print(output_stepwise)

write.csv(output_stepwise, "/Users/michelle/Documents/thesis/remittance regressions/output_stepwise_3_WAGECONTROL_EXR.csv", row.names = TRUE)

```






# SUMMARY STATS



Load in libraries.
```{r libraries}
library(readr)
library(dplyr)
library(knitr)
library(kableExtra)
library(webshot2) 
library(magrittr)
library(tidyr)
```

Summary statistics
```{r}
summary_table <- fulldata_copy %>%
  dplyr::select(-Month) %>%
  summarise(across(everything(), list(
    Mean = ~mean(., na.rm = TRUE),
    SD = ~sd(., na.rm = TRUE),
    Min = ~min(., na.rm = TRUE),
    Max = ~max(., na.rm = TRUE),
    N = ~sum(!is.na(.))
  ), .names = "{.col}_{.fn}")) %>%
  pivot_longer(cols = everything(),
               names_to = c("Variable", ".value"),
               names_pattern = "^(.*)_(Mean|SD|Min|Max|N)$")

#Table
kable_out <- summary_table %>%
  kable("html", caption = "Summary Statistics for Monthly variables", digits = 2) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), 
                full_width = F, 
                position = "center") %>%
  column_spec(1, bold = T) %>%
  add_header_above(c(" " = 1, "Statistics" = 5))

save_kable(kable_out, "summary_statistics_monthly.html")
```

Correlation matrix
```{r}
# Load necessary packages
library(urca)
library(dplyr)

cor_matrix <- fulldata_copy %>%
  filter(Month <= as.Date("2024-09-01") & Month >= as.Date("2016-01-01"))%>%
  dplyr::select(where(~ !any(is.na(.)))) %>%
  dplyr::select(-Month) %>%
  cor(use = "complete.obs")
print(cor_matrix)

# Save the kable as an HTML file
save_kable(kable(cor_matrix, caption = "Correlation Matrix of Variables: Monthly", format = "html"), "correlation_matrix_monthly.html")
```

```{r}
# Load necessary libraries
library(ggplot2)
library(dplyr)

# Assuming your data is named 'data' and the remittances column is "Remittances_fromRus"
ggplot(fulldata_copy, aes(x = Month, y = Remittances_fromRus)) +
  geom_line(color = "blue") +  # Line plot
  labs(title = "Time Series of Remittances from Russia",
       subtitle = "Source: National Bank of Kyrgyzstan",
       x = "Month",
       y = "Remittances (in millions of US dollars)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels for readability

ggsave("/Users/michelle/Documents/thesis/remittances_timeseries.png", plot = last_plot(), width = 10, height = 8, dpi = 300)
```



