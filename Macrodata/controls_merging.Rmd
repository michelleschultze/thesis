This file will merge together the region-year and region-month data by extracting it from several data files. 

Load in packages
```{r}
library(readxl)
library(dplyr)
library(tidyr)
library(janitor)
library(zoo)
library(stringr)
library(lubridate)
library(tidyverse)
```

##Set up region dictionary (standardizing names)
```{r}
region_dict <- data.frame(
  Russian = c(
    "Алтайский край", "Амурская область", "Архангельская область", 
    "Архангельская область                       без автономного округа", 
    "Астраханская область", "Белгородская область", "Брянская область", 
    "Владимирская область", "Волгоградская область", "Вологодская область", 
    "Воронежская область", "г.Москва", "г.Санкт-Петербург", 
    "г.Севастополь", "Дальневосточный федеральный округ", 
    "Еврейская автономная область", "Забайкальский край", 
    "Ивановская область", "Иркутская область", 
    "Кабардино-Балкарская Республика", "Калининградская область", 
    "Калужская область", "Камчатский край", 
    "Карачаево-Черкесская Республика", "Кемеровская область", 
    "Кировская область", "Костромская область", "Краснодарский край", 
    "Красноярский край", "Курганская область", "Курская область", 
    "Ленинградская область", "Липецкая область", "Магаданская область", 
    "Московская область", "Мурманская область", "Ненецкий автономный округ", 
    "Нижегородская область", "Новгородская область", 
    "Новосибирская область", "Омская область", "Оренбургская область", 
    "Орловская область", "Пензенская область", "Пермский край", 
    "Приволжский федеральный округ", "Приморский край", 
    "Псковская область", "Республика Адыгея", "Республика Алтай", 
    "Республика Башкортостан", "Республика Бурятия", 
    "Республика Дагестан", "Республика Ингушетия", "Республика Калмыкия", 
    "Республика Карелия", "Республика Коми", "Республика Крым", 
    "Республика Марий Эл", "Республика Мордовия", "Республика Саха (Якутия)", 
    "Республика Северная Осетия-Алания", "Республика Татарстан", 
    "Республика Тыва", "Республика Хакасия", "Ростовская область", 
    "Рязанская область", "Самарская область", "Саратовская область", 
    "Сахалинская область", "Свердловская область", 
    "Северо-Западный федеральный округ", "Северо-Кавказский федеральный округ", 
    "Сибирский федеральный округ", "Смоленская область", "Ставропольский край", 
    "Тамбовская область", "Тверская область", "Томская область", 
    "Тульская область", "Тюменская область", 
    "Тюменская область                             без автономных округов", 
    "Удмуртская Республика", "Ульяновская область", 
    "Уральский федеральный округ", "Хабаровский край", 
    "Ханты-Мансийский автономный                 округ-Югра", 
    "Центральный федеральный округ", "Челябинская область", 
    "Чеченская Республика", "Чувашская Республика", 
    "Чукотский автономный округ", "Южный федеральный округ", 
    "Ямало-Ненецкий автономный округ", "Ярославская область"
  ),
  English = c(
    "Altai Krai", "Amur Oblast", "Arkhangel'skaya Oblast'", 
    "Arkhangelskaya Oblast without Autonomous Okrug", 
    "Astrakhan Oblast", "Belgorod Oblast", "Bryansk Oblast", 
    "Vladimir Oblast", "Volgograd Oblast", "Vologda Oblast", 
    "Voronezh Oblast", "Moscow", "Saint Petersburg", 
    "Sevastopol", "Far Eastern Federal District", 
    "Jewish Autonomous Oblast", "Zabaykalsky Krai", 
    "Ivanovo Oblast", "Irkutsk Oblast", 
    "The Kabardino-Balkar Republic", "Kaliningrad Oblast", 
    "Kaluga Oblast", "Kamchatka Krai", 
    "Karachay-Cherkess Republic", "Kemerovo Oblast", 
    "Kirov Oblast", "Kostroma Oblast", "Krasnodar Krai", 
    "Krasnoyarsk Krai", "Kurgan Oblast", "Kursk Oblast", 
    "Leningrad Oblast", "Lipetsk Oblast", "Magadan District", 
    "Moscow Oblast", "Murmansk Oblast", "Nenets Autonomous Okrug", 
    "Nizhny Novgorod Oblast'", "Novgorod Oblast", 
    "Novosibirsk Oblast", "Omsk Oblast", "Orenburg Oblast", 
    "Oryol Oblast", "Penza Oblast", "Perm Krai", 
    "Volga Federal District", "Primorsky Krai", 
    "Pskov Oblast", "Republic of Adygea", "Altai Republic", 
    "Republic of Bashkortostan", "Republic of Buryatia", 
    "Republic of Dagestan", "Republic of Ingushetia", "Republic of Kalmykia", 
    "Republic of Karelia", "Komi Republic", "Republic of Crimea", 
    "Mari El Republic", "Republic of Mordovia", "Sakha (Yakutia) Republic", 
    "Republic of North Ossetia — Alania", "Republic of Tatarstan", 
    "Tyva Republic", "Republic of Khakassia", "Rostov Oblast", 
    "Ryazan Oblast", "Samara Oblast", "Saratov Oblast", 
    "Sakhalin District", "Sverdlovsk Oblast", 
    "North-Western Federal District", "North Caucasian Federal District", 
    "Siberian Federal District", "Smolensk Oblast", "Stavropol Krai", 
    "Tambov Oblast", "Tver Oblast", "Tomsk District", 
    "Tula Oblast", "Tyumen Oblast", 
    "Tyumen Oblast without Autonomous Okrugs", 
    "Udmurt Republic", "Ulyanovsk Oblast", 
    "Ural Federal District", "Khabarovsk Krai", 
    "Khanty-Mansi Autonomous Okrug — Yugra", 
    "Central Federal District", "Chelyabinsk Oblast", 
    "Chechen Republic", "Chuvash Republic", 
    "Chukotka Autonomous Okrug", "Southern Federal District", 
    "Yamalo-Nenets Autonomous Okrug", "Yaroslavl Oblast"
  )
)
```

##Change in real avg wages from previous year (2018-2023)
```{r}
data_changeinrealavgwages <- read_excel("Macrodata/Raw macrodata/region-year_rosstat_changeinrealavgwages.xlsx", 
                                                       sheet = "с 2018", 
                                                       skip = 2)

data_changeinrealavgwages <- data_changeinrealavgwages %>%
  rename(Region = 1) %>%
  filter(grepl("область|край|республика|Республика|Москва|Петербург|округ", Region))

#Test what doesn't match dictionary
data_changeinrealavgwages %>%
  filter(!(Region %in% region_dict$Russian))

#Prep to standardize
data_changeinrealavgwages <- data_changeinrealavgwages %>%
  mutate(Region = case_when(
    Region == "г. Москва" ~ "г.Москва",
    Region == "в том числе Ненецкий авт.округ" ~ "Ненецкий автономный округ",
    Region == "Архангельская область без авт. округа" ~ "Архангельская область                       без автономного округа",
    Region == "Республика Северная Осетия - Алания" ~ "Республика Северная Осетия-Алания",
    Region == "Ханты-Мансийский авт.округ - Югра" ~ "Ханты-Мансийский автономный                 округ-Югра",
    Region == "Ямало-Ненецкий авт.округ" ~ "Ямало-Ненецкий автономный округ",
    Region == "Тюменская область без авт. округов" ~ "Тюменская область                             без автономных округов",
    Region == "Еврейская авт.область" ~ "Еврейская автономная область",
    Region == "Чукотский авт.округ" ~ "Чукотский автономный округ",
    TRUE ~ Region
  ))

#Check for prep complete
data_changeinrealavgwages %>%
  filter(!(Region %in% region_dict$Russian))

#Check for duplicates
data_changeinrealavgwages %>%
  group_by(Region) %>%
  filter(n() > 1) %>%
  distinct(Region)

#Ready to standardize names
data_changeinrealavgwages <- data_changeinrealavgwages %>%
  left_join(region_dict, by = c("Region" = "Russian")) %>%
  mutate(Region = ifelse(is.na(English), Region, English)) %>%
  select(-English)  # Remove the extra column after replacement

unmatched_regions <- data_changeinrealavgwages %>%
  filter(!(Region %in% region_dict$English))
print(unmatched_regions) #Success!
```

##Poverty rate (2018-2023)
```{r}
data_povertyrate <- read_excel("Macrodata/Raw macrodata/region-year_rosstat_povertyrate.xlsx", 
    sheet = "по РФ и субъектам РФ 2018-2023", 
    skip = 2)

data_povertyrate <- data_povertyrate %>%
  rename(Region = 1) %>%
  filter(grepl("область|край|республика|Республика|Москва|Петербург|округ", Region))

#Test what doesn't match dictionary
data_povertyrate %>%
  filter(!(Region %in% region_dict$Russian))

#Prep to standardize
data_povertyrate <- data_povertyrate %>%
  mutate(Region = case_when(
    Region == "г. Москва" ~ "г.Москва",
    Region == "в том числе: Ненецкий автономный округ" ~ "Ненецкий автономный округ",
    Region == "Архангельская область без авт. округа" ~ "Архангельская область                       без автономного округа",
    Region == "Республика Северная Осетия - Алания" ~ "Республика Северная Осетия-Алания",
    Region == "в том числе: Ханты-Мансийский автономный округ-Югра" ~ "Ханты-Мансийский автономный                 округ-Югра",
    Region == "Ямало-Ненецкий авт.округ" ~ "Ямало-Ненецкий автономный округ",
    Region == "Тюменская область без авт. округов" ~ "Тюменская область                             без автономных округов",
    Region == "Еврейская авт.область" ~ "Еврейская автономная область",
    Region == "Чукотский авт.округ" ~ "Чукотский автономный округ",
    Region == "г. Санкт-Петербург" ~ "г.Санкт-Петербург",
    Region == "Южный федеральный  округ" ~ "Южный федеральный округ",
    TRUE ~ Region
  ))

#Check for prep complete
data_povertyrate %>%
  filter(!(Region %in% region_dict$Russian))

#Check for duplicates
data_povertyrate %>%
  group_by(Region) %>%
  filter(n() > 1) %>%
  distinct(Region)

#Ready to standardize names
data_povertyrate <- data_povertyrate %>%
  left_join(region_dict, by = c("Region" = "Russian")) %>%
  mutate(Region = ifelse(is.na(English), Region, English)) %>%
  select(-English)  # Remove the extra column after replacement

unmatched_regions <- data_povertyrate %>%
  filter(!(Region %in% region_dict$English))
print(unmatched_regions) #Success!
```

##Year-on-year percentage change in economic output ("index") (2018-2024)
```{r}
data_changeinoutput <- read_excel("Macrodata/Raw macrodata/region-month_rosstat_2022-24_output.xlsx", 
    sheet = "3", skip = 2)

data_changeinoutput <- data_changeinoutput %>%
  rename(Region = 1) %>%
  filter(grepl("область|край|республика|Республика|Москва|Петербург|округ", Region))

#Test what doesn't match dictionary
x <- data_changeinoutput %>%
  filter(!(Region %in% region_dict$Russian))
x$Region

#Prep to standardize
data_changeinoutput <- data_changeinoutput %>%
  mutate(Region = case_when(
    Region == "Тюменская область (без Ханты-Мансийского авт.округа-Югра и Ямало-Ненецкого авт.округа)" ~ "Тюменская область                             без автономных округов",
    Region == "в т.ч. Ненецкий авт. округ" ~ "Ненецкий автономный округ",
    Region == "Архангельская область без Ненецкого авт.округа" ~ "Архангельская область                       без автономного округа",
    Region == "в т.ч. Ханты-Мансийский автономный округ-Югра" ~ "Ханты-Мансийский автономный                 округ-Югра",
    TRUE ~ Region
  ))

#Ready to standardize names
data_changeinoutput <- data_changeinoutput %>%
  left_join(region_dict, by = c("Region" = "Russian")) %>%
  mutate(Region = ifelse(is.na(English), Region, English)) %>%
  select(-English)  # Remove the extra column after replacement

unmatched_regions <- data_changeinoutput %>%
  filter(!(Region %in% region_dict$English))
print(unmatched_regions) #Success!
```

##Industrial output indices

###Load the data in (loop over 5 sheets, merge years/months, clean)
```{r}
# Define sheet numbers to loop over
sheets_to_read <- c("1", "4", "7", "10", "13")

# Create an empty list to store cleaned data
cleaned_data_list <- list()

# Loop over each sheet
for (sheet_num in sheets_to_read) {
  
  # Step 1: Import data
  raw_data <- read_excel("Macrodata/Raw macrodata/region-month_rosstat_industrialoutput.xlsx", 
                         sheet = sheet_num, skip = 1, col_names = FALSE)  # Read without headers
  
  # Step 2: Extract relevant parts
  years <- as.character(unlist(raw_data[3, ]))  # Extract year row
  months <- as.character(unlist(raw_data[4, ])) # Extract month row
  
  # **NEW**: Remove superscript footnotes and extra characters
  months <- str_replace_all(months, "[^а-яА-Я]", "")  # Keep only Russian letters
  
  # Step 3: Propagate year values
  year_filled <- na.locf(years, na.rm = FALSE) # Fill down nearest year
  year_filled <- make.names(year_filled, unique = TRUE)  # Add .a, .b, etc.
  
  # Step 4: Create final column names
  column_names <- paste(year_filled, months, sep = "_")
  
  # Step 5: Assign new column names and clean up data
  cleaned_data <- raw_data[-c(1:4), ]  # Remove first 4 rows (headers)
  colnames(cleaned_data) <- c("Region", column_names[-1])  # Keep "Region" as the first column
  
  # Step 6: Extract year and month separately
  cleaned_columns <- str_replace_all(colnames(cleaned_data), "X|\\.год|\\.\\d+", "")  # Remove extra text
  month_year_split <- str_match(cleaned_columns, "(\\d{4})_(.*)")  # Extract Year and Month parts
  years <- month_year_split[, 2]  # Year column
  months_russian <- month_year_split[, 3]  # Month column
  
  # **NEW**: Clean up month names again before translation
  months_russian <- str_replace_all(months_russian, "[^а-яА-Я]", "")  # Keep only Russian letters
  
  # Step 7: Translate months
  month_translation <- c("январь" = "January", "февраль" = "February", "март" = "March",
                         "апрель" = "April", "май" = "May", "июнь" = "June",
                         "июль" = "July", "август" = "August", "сентябрь" = "September",
                         "октябрь" = "October", "ноябрь" = "November", "декабрь" = "December")
  
  months_english <- recode(months_russian, !!!month_translation)  # Convert Russian months to English
  
  # Step 8: Create new formatted names
  new_column_names <- ifelse(!is.na(years) & !is.na(months_english), paste(months_english, years), "Region")
  
  # Step 9: Assign cleaned column names
  colnames(cleaned_data) <- new_column_names
  
  # Step 10: Store the cleaned data in a list
  cleaned_data_list[[paste0("Sheet_", sheet_num)]] <- cleaned_data
}

# Display the first few rows of each cleaned dataset
lapply(cleaned_data_list, head)
```

###Clean the region names
```{r}
# Loop through each data frame in cleaned_data_list
for (sheet_name in names(cleaned_data_list)) {
  cleaned_data_list[[sheet_name]] <- cleaned_data_list[[sheet_name]] %>%
    rename(Region = 1) %>%
    filter(grepl("область|край|республика|Республика|Москва|Петербург|округ", Region))
  
  # Test what doesn't match dictionary
  x <- cleaned_data_list[[sheet_name]] %>%
    filter(!(Region %in% region_dict$Russian))
  #print(x$Region)
  
  #Prep to standardize
  cleaned_data_list[[sheet_name]] <- cleaned_data_list[[sheet_name]] %>%
    mutate(Region = case_when(
      Region == "г. Москва" ~ "г.Москва",
      Region == "в том числе Ненецкий авт.округ" ~ "Ненецкий автономный округ",
      Region == "в том числе               Ненецкий авт.округ" ~ "Ненецкий автономный округ",
      Region == "в том числе               Ненецкий авт. округ" ~ "Ненецкий автономный округ",
      Region == "в том числе               \nНенецкий авт.округ" ~ "Ненецкий автономный округ",
      Region == "Архангельская область без авт. округа" ~ "Архангельская область                       без автономного округа",
      Region == "г. Санкт-Петербург" ~ "г.Санкт-Петербург",
      Region == "Республика Северная  Осетия - Алания" ~ "Республика Северная Осетия-Алания",
      Region == "Приволжский               федеральный округ" ~ "Приволжский федеральный округ",
      Region == "Уральский  федеральный округ" ~ "Уральский федеральный округ",
      Region == "Уральский             федеральный округ" ~ "Уральский федеральный округ",
      Region == "в том числе: Ханты-Мансийский авт. округ - Югра" ~ "Ханты-Мансийский автономный                 округ-Югра",
      Region == "в том числе:                     Ханты-Мансийский       авт. округ - Югра" ~ "Ханты-Мансийский автономный                 округ-Югра",
      Region == "в том числе:                     \nХанты-Мансийский авт. округ - Югра" ~ "Ханты-Мансийский автономный                 округ-Югра",
      Region == "Ямало-Ненецкий авт. округ" ~ "Ямало-Ненецкий автономный округ",
      Region == "Ямало-Ненецкий             авт. округ" ~ "Ямало-Ненецкий автономный округ",
      Region == "Тюменская область без авт. округов" ~ "Тюменская область                             без автономных округов",
      Region == "Еврейская авт.область" ~ "Еврейская автономная область",
      Region == "Еврейская авт. область" ~ "Еврейская автономная область",
      Region == "Чукотский авт.округ" ~ "Чукотский автономный округ",
      Region == "Чукотский авт. округ" ~ "Чукотский автономный округ",
      Region == "Южный                   федеральный округ" ~ "Change",
      Region == "Сибирский           федеральный округ" ~ "Сибирский федеральный округ",
      TRUE ~ Region
    ))
  
  #Ready to standardize names
  cleaned_data_list[[sheet_name]] <- cleaned_data_list[[sheet_name]] %>%
    left_join(region_dict, by = c("Region" = "Russian")) %>%
    mutate(Region = ifelse(is.na(English), Region, English)) %>%
    select(-English)  # Remove the extra column after replacement
  
  unmatched_regions <- cleaned_data_list[[sheet_name]] %>%
    filter(!(Region %in% region_dict$English))
  print(unmatched_regions$Region) #Success!
  
}
```

###Rename the datasets
```{r}
# Rename the list
data_changeinindustrialproduction <- cleaned_data_list

# Define new names for each sheet
sheet_names <- c("total", "mineral_extraction", "manufacturing",
                 "electricity_utilities", "water_utilities")

# Rename list elements and modify each data frame
names(data_changeinindustrialproduction) <- sheet_names
```

###Convert to the proper format and merge
```{r}
final_data <- list()

# Loop through each sheet in the cleaned data list
for (sheet_name in names(cleaned_data_list)) {
  
  # Step 1: Convert the dataset from wide to long format
  data_long <- cleaned_data_list[[sheet_name]] %>%
    pivot_longer(
      cols = starts_with("January 2015"):ends_with("December 2024"), 
      names_to = "Month_Year", 
      values_to = sheet_name  # Use the sheet name as the column name
    )
  
  # Step 2: Convert the "Month_Year" column to Date format (assuming it's in the "Month Year" format)
  data_long <- data_long %>%
    mutate(Month_Year = my(Month_Year))
  
  # Step 3: Add the data to the final_data list
  final_data[[sheet_name]] <- data_long
}

# Step 4: Merge all the data into a single dataset
# We'll perform a full join on the common columns "Region" and "Month_Year"
final_data_merged <- reduce(final_data, full_join, by = c("Region", "Month_Year")) %>%
  mutate(Month_Year_display = format(Month_Year, "%B %Y"))

# View the final merged dataset
head(final_data_merged)
```


#Merge data 

##All sets imported: 
data_changeinindustrialproduction$total (region/month, 2015-24)
data_changeinindustrialproduction$mineral_extraction (region/month, 2015-24)
data_changeinindustrialproduction$manufacturing (region/month, 2015-24)
data_changeinindustrialproduction$electricity_utilities (region/month, 2015-24)
data_changeinindustrialproduction$water_utilities (region/month, 2015-24)
data_povertyrate (region/year, 2018-23)
data_changeinoutput (region/year, 2018-23)
data_changeinrealavgwages (region/year, 2018-23)

##into a region-year set, 2022-23, vars wide and time/region long 
(matches inflows data for first two regressions)
```{r}

```

